<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/favicon.ico?v=5.1.4" color="#222">





  <meta name="keywords" content="SpringCloud,Netflix," />





  <link rel="alternate" href="/atom.xml" title="CloudPai" type="application/atom+xml" />






<meta name="description" content="1 为什么微服务架构需要 Spring Cloud简单来说，服务化的核心就是将传统的一站式应用根据业务拆分成一个一个的服务，而微服务在这个基础上要更彻底地去耦合（不再共享 DB、KV，去掉重量级 ESB），并且强调 DevOps 和快速演化。这就要求我们必须采用与一站式时代、泛 SOA 时代不同的技术栈，而 Spring Cloud 就是其中的佼佼者。  DevOps 是英文 Developme">
<meta name="keywords" content="SpringCloud,Netflix">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Cloud 技术分析:Netflix 组件">
<meta property="og:url" content="http://cloudpai.site/2018/05/26/2018-05-26-1/index.html">
<meta property="og:site_name" content="CloudPai">
<meta property="og:description" content="1 为什么微服务架构需要 Spring Cloud简单来说，服务化的核心就是将传统的一站式应用根据业务拆分成一个一个的服务，而微服务在这个基础上要更彻底地去耦合（不再共享 DB、KV，去掉重量级 ESB），并且强调 DevOps 和快速演化。这就要求我们必须采用与一站式时代、泛 SOA 时代不同的技术栈，而 Spring Cloud 就是其中的佼佼者。  DevOps 是英文 Developme">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-Spring_Cloud_技术分析（序）___网易乐得技术团队/image1">
<meta property="og:image" content="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-Spring_Cloud_技术分析（序）___网易乐得技术团队/image2">
<meta property="og:image" content="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-Spring_Cloud_技术分析（序）___网易乐得技术团队/image3">
<meta property="og:image" content="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-微服务架构的服务与发现_-_Spring_Cloud/image3">
<meta property="og:image" content="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-微服务架构的服务与发现_-_Spring_Cloud/image4">
<meta property="og:image" content="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-微服务架构的服务与发现_-_Spring_Cloud/image5">
<meta property="og:image" content="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-微服务架构的服务与发现_-_Spring_Cloud/image6">
<meta property="og:image" content="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-微服务架构的服务与发现_-_Spring_Cloud/image7">
<meta property="og:image" content="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-微服务架构的服务与发现_-_Spring_Cloud/image8">
<meta property="og:image" content="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-微服务架构的服务与发现_-_Spring_Cloud/image9">
<meta property="og:image" content="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-微服务架构的服务与发现_-_Spring_Cloud/image10">
<meta property="og:updated_time" content="2018-05-26T12:04:48.965Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring Cloud 技术分析:Netflix 组件">
<meta name="twitter:description" content="1 为什么微服务架构需要 Spring Cloud简单来说，服务化的核心就是将传统的一站式应用根据业务拆分成一个一个的服务，而微服务在这个基础上要更彻底地去耦合（不再共享 DB、KV，去掉重量级 ESB），并且强调 DevOps 和快速演化。这就要求我们必须采用与一站式时代、泛 SOA 时代不同的技术栈，而 Spring Cloud 就是其中的佼佼者。  DevOps 是英文 Developme">
<meta name="twitter:image" content="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-Spring_Cloud_技术分析（序）___网易乐得技术团队/image1">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'TZAS2SFOJR',
      apiKey: 'e2a9cd036eede8026382b302001ec261',
      indexName: 'cloudpai_blogs_search',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://cloudpai.site/2018/05/26/2018-05-26-1/"/>





  <title>Spring Cloud 技术分析:Netflix 组件 | CloudPai</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-114643720-1', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">CloudPai</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">个人博客</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            时间轴
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>




 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://cloudpai.site/2018/05/26/2018-05-26-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CloudPai">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p4lmrb1gp.bkt.clouddn.com/君名-squashed.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CloudPai">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Spring Cloud 技术分析:Netflix 组件</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-26T19:19:31+08:00">
                2018-05-26
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-05-26T20:04:48+08:00">
                2018-05-26
              </time>
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/05/26/2018-05-26-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/05/26/2018-05-26-1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  6,423
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  24
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <script src="/assets/js/APlayer.min.js"> </script><h1 id="1-为什么微服务架构需要-Spring-Cloud"><a href="#1-为什么微服务架构需要-Spring-Cloud" class="headerlink" title="1 为什么微服务架构需要 Spring Cloud"></a><a href="#1-为什么微服务架构需要Spring-Cloud" title="1 为什么微服务架构需要Spring Cloud"></a>1 为什么微服务架构需要 Spring Cloud</h1><p>简单来说，服务化的核心就是将传统的一站式应用根据业务拆分成一个一个的服务，而微服务在这个基础上要更彻底地去耦合（不再共享 DB、KV，去掉重量级 ESB），并且强调 DevOps 和快速演化。这就要求我们必须采用与一站式时代、泛 SOA 时代不同的技术栈，而 Spring Cloud 就是其中的佼佼者。</p>
<blockquote>
<p>DevOps 是英文 Development 和 Operations 的合体，他要求开发、测试、运维进行一体化的合作，进行更小、更频繁、更自动化的应用发布，以及围绕应用架构来构建基础设施的架构。这就要求应用充分的内聚，也方便运维和管理。这个理念与微服务理念不谋而合。</p>
</blockquote>
<p>接下来我们从服务化架构演进的角度来看看为什么 Spring Cloud 更适应微服务架构。</p>
<h2 id="1-1-从使用-nginx-说起"><a href="#1-1-从使用-nginx-说起" class="headerlink" title="1.1 从使用 nginx 说起"></a><a href="#1-1-从使用nginx说起" title="1.1 从使用nginx说起"></a>1.1 从使用 nginx 说起</h2><p>最初的服务化解决方案是给提供相同服务提供一个统一的域名，然后服务调用者向这个域名发送 HTTP 请求，由 Nginx 负责请求的分发和跳转。</p>
<center><a href="/2017/03/15/rd/server/SpringCloud0/NginxArch.png"><img src="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-Spring_Cloud_技术分析（序）___网易乐得技术团队/image1" alt=""></a></center>

<p>这种架构存在很多问题:</p>
<ul>
<li>Nginx 作为中间层，在配置文件中耦合了服务调用的逻辑，这削弱了微服务的完整性，也使得 Nginx 在一定程度上变成了一个重量级的 ESB。</li>
<li>服务的信息分散在各个系统，无法统一管理和维护。每一次的服务调用都是一次尝试，服务消费者并不知道有哪些实例在给他们提供服务。这不符合 DevOps 的理念。</li>
<li>无法直观的看到服务提供者和服务消费者当前的运行状况和通信频率。这也不符合 DevOps 的理念。</li>
<li>消费者的失败重发，负载均衡等都没有统一策略，这加大了开发每个服务的难度，不利于快速演化。</li>
</ul>
<p>为了解决上面的问题，我们需要一个<strong>现成的</strong>中心组件对服务进行整合，将每个服务的信息汇总，包括服务的组件名称、地址、数量等。服务的调用方在请求某项服务时首先通过中心组件获取提供这项服务的实例的信息（IP、端口等），再通过默认或自定义的策略选择该服务的某一提供者<strong>直接</strong>进行访问。所以，我们引入了 Dubbo。</p>
<h2 id="1-2-基于-Dubbo-实现微服务"><a href="#1-2-基于-Dubbo-实现微服务" class="headerlink" title="1.2 基于 Dubbo 实现微服务"></a><a href="#1-2-基于Dubbo实现微服务" title="1.2 基于Dubbo实现微服务"></a>1.2 基于 Dubbo 实现微服务</h2><p>Dubbo 是阿里开源的一个 SOA 服务治理解决方案，文档丰富，在国内的使用度非常高。</p>
<p>使用 Dubbo 构建的微服务，已经可以比较好地解决上面提到的问题：</p>
<center><a href="/2017/03/15/rd/server/SpringCloud0/DubboArch.png"><img src="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-Spring_Cloud_技术分析（序）___网易乐得技术团队/image2" alt=""></a></center>

<ul>
<li><p>调用中间层变成了可选组件，消费者可以直接访问服务提供者。</p>
</li>
<li><p>服务信息被集中到 Registry 中，形成了服务治理的中心组件。</p>
</li>
<li><p>通过 Monitor 监控系统，可以直观地展示服务调用的统计信息。</p>
</li>
<li><p>Consumer 可以进行负载均衡、服务降级的选择。</p>
</li>
</ul>
<p>但是对于微服务架构而言，Dubbo 也并不是十全十美的：</p>
<ul>
<li><p>Registry 严重依赖第三方组件（zookeeper 或者 redis），当这些组件出现问题时，服务调用很快就会中断。</p>
</li>
<li><p>DUBBO 只支持 RPC 调用。使得服务提供方与调用方在代码上产生了强依赖，服务提供者需要不断将包含公共代码的 jar 包打包出来供消费者使用。一旦打包出现问题，就会导致服务调用出错。</p>
</li>
<li><p>最为重要的是，DUBBO 现在已经停止维护了，对于技术发展的新需求，需要由开发者自行拓展升级。这对于很多想要采用微服务架构的中小软件组织，显然是不太合适的。</p>
</li>
</ul>
<blockquote>
<p>目前 Github 社区上有一个 DUBBO 的升级版，叫 DUBBOX，提供了更高效的 RPC 序列化方式和 REST 调用方式。但是该项目也基本停止维护了。</p>
</blockquote>
<h2 id="1-3-新的选择——Spring-Cloud"><a href="#1-3-新的选择——Spring-Cloud" class="headerlink" title="1.3 新的选择——Spring Cloud"></a><a href="#1-3-新的选择——Spring-Cloud" title="1.3 新的选择——Spring Cloud"></a>1.3 新的选择——Spring Cloud</h2><p>作为新一代的服务框架，Spring Cloud 提出的口号是开发 “面向云环境的应用程序”，它为微服务架构提供了更加全面的技术支持。<br>结合我们一开始提到的微服务的诉求，我们把 Spring Cloud 与 DUBBO 进行一番对比：</p>
<table>
<thead>
<tr>
<th>微服务需要的功能</th>
<th>Dubbo</th>
<th>Spring Cloud</th>
</tr>
</thead>
<tbody>
<tr>
<td>服务注册和发现</td>
<td>Zookeeper</td>
<td>Eureka</td>
</tr>
<tr>
<td>服务调用方式</td>
<td>RPC</td>
<td>RESTful API</td>
</tr>
<tr>
<td>断路器</td>
<td>有</td>
<td>有</td>
</tr>
<tr>
<td>负载均衡</td>
<td>有</td>
<td>有</td>
</tr>
<tr>
<td>服务路由和过滤</td>
<td>有</td>
<td>有</td>
</tr>
<tr>
<td>分布式配置</td>
<td>无</td>
<td>有</td>
</tr>
<tr>
<td>分布式锁</td>
<td>无</td>
<td>计划开发</td>
</tr>
<tr>
<td>集群选主</td>
<td>无</td>
<td>有</td>
</tr>
<tr>
<td>分布式消息</td>
<td>无</td>
<td>有</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Spring Cloud 抛弃了 Dubbo 的 RPC 通信，采用的是基于 HTTP 的 REST 方式。严格来说，这两种方式各有优劣。虽然从一定程度上来说，后者牺牲了服务调用的性能，但也避免了上面提到的原生 RPC 带来的问题。而且 REST 相比 RPC 更为灵活，服务提供方和调用方的依赖只依靠一纸契约，不存在代码级别的强依赖，这在强调快速演化的微服务环境下，显得更加合适。</p>
</blockquote>
<hr>
<blockquote>
<p>Eureka 相比于 zookeeper，更加适合于服务发现的场景，这点会在下一篇会详细展开。</p>
</blockquote>
<p>很明显，Spring Cloud 的功能比 DUBBO 更加强大，涵盖面更广，而且作为 Spring 的拳头项目，它也能够与 Spring Framework、Spring Boot、Spring Data、Spring Batch 等其他 Spring 项目完美融合，这些对于微服务而言是至关重要的。前面提到，微服务背后一个重要的理念就是持续集成、快速交付，而在服务内部使用一个统一的技术框架，显然比把分散的技术组合到一起更有效率。更重要的是，相比于 Dubbo，它是一个正在持续维护的、社区更加火热的开源项目，这就保证使用它构建的系统，可以持续地得到开源力量的支持。</p>
<h1 id="2-Spring-Cloud-技术概览"><a href="#2-Spring-Cloud-技术概览" class="headerlink" title="2 Spring Cloud 技术概览"></a><a href="#2-Spring-Cloud技术概览" title="2 Spring Cloud技术概览"></a>2 Spring Cloud 技术概览</h1><p>下图展示了 Spring Cloud 的完整技术组成：</p>
<center><a href="/2017/03/15/rd/server/SpringCloud0/SpringCloudTechs.png"><img src="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-Spring_Cloud_技术分析（序）___网易乐得技术团队/image3" alt=""></a></center>

<ul>
<li>服务治理：这是 Spring Cloud 的核心。目前 Spring Cloud 主要通过整合 Netflix 的相关产品来实现这方面的功能（Spring Cloud Netflix），包括用于服务注册和发现的 Eureka，调用断路器 Hystrix，调用端负载均衡 Ribbon，Rest 客户端 Feign，智能服务路由 Zuul，用于监控数据收集和展示的 Spectator、Servo、Atlas，用于配置读取的 Archaius 和提供 Controller 层 Reactive 封装的 RxJava。除此之外，针对<iframe id="tmp_downloadhelper_iframe" style="display: none;"></iframe>

</li>
</ul>
<blockquote>
<p>Feign 和 RxJava 并不是 Netiflix 的产品，但是被整合到了 Spring Cloud Netflix 中。</p>
</blockquote>
<hr>
<blockquote>
<p>对于服务的注册和发现，除了 Eureka，Spring Cloud 也整合了 Consul 和 Zookeeper 作为备选，但是因为这两个方案在 CAP 理论上都遵循 CP 而不是 AP（下一篇会详细介绍这点），所以官方并没有推荐使用。</p>
</blockquote>
<ul>
<li><p>分布式链路监控：Spring Cloud Sleuth 提供了全自动、可配置的数据埋点，以收集微服务调用链路上的性能数据，并发送给 Zipkin 进行存储、统计和展示。</p>
</li>
<li><p>消息组件：Spring Cloud Stream 对于分布式消息的各种需求进行了抽象，包括发布订阅、分组消费、消息分片等功能，实现了微服务之间的异步通信。Spring Cloud Stream 也集成了第三方的 RabbitMQ 和 Apache Kafka 作为消息队列的实现。而 Spring Cloud Bus 基于 Spring Cloud Stream，主要提供了服务间的事件通信（比如刷新配置）。</p>
</li>
<li><p>配置中心：基于 Spring Cloud Netflix 和 Spring Cloud Bus，Spring 又提供了 Spring Cloud Config，实现了配置集中管理、动态刷新的配置中心概念。配置通过 Git 或者简单文件来存储，支持加解密。</p>
</li>
<li><p>安全控制：Spring Cloud Security 基于 OAUTH2 这个开放网络的安全标准，提供了微服务环境下的单点登录、资源授权、令牌管理等功能。</p>
</li>
<li><p>命令行工具：Spring Cloud Cli 提供了以命令行和脚本的方式来管理微服务及 Spring Cloud 组件的方式。</p>
</li>
<li><p>集群工具：Spring Cloud Cluster 提供了集群选主、分布式锁（暂未实现）、一次性令牌（暂未实现）等分布式集群需要的技术组件。</p>
</li>
</ul>
<p>后续章节我们会详细介绍我们实际使用到的 Spring Cloud 组件。</p>
<h1 id="2-Spring-Cloud-Netflix-组件"><a href="#2-Spring-Cloud-Netflix-组件" class="headerlink" title="2. Spring Cloud Netflix 组件"></a>2. Spring Cloud Netflix 组件</h1><blockquote>
<p>Netflix 和 Spring Cloud 是什么关系呢？Netflix 是一家成功实践微服务架构的互联网公司，几年前，Netflix 就把它的几乎整个微服务框架栈开源贡献给了社区。Spring 背后的 Pivotal 在 2015 年推出的 Spring Cloud 开源产品，主要对 Netflix 开源组件的进一步封装，方便 Spring 开发人员构建微服务基础框架。<br>对于微服务的治理而言，核心就是服务的注册和发现。所以选择哪个组件，很大程度上要看它对于服务注册与发现的解决方案。在这个领域，开源架构很多，最常见的是 Zookeeper，但这并不是一个最佳选择。</p>
</blockquote>
<p>在分布式系统领域有个著名的 CAP 定理：<strong>C——数据一致性，A——服务可用性，P——服务对网络分区故障的容错性</strong>。这三个特性在任何分布式系统中不能同时满足，最多同时满足两个。</p>
<p>Zookeeper 是著名 Hadoop 的一个子项目，很多场景下 Zookeeper 也作为 Service 发现服务解决方案。<strong>Zookeeper 保证的是 CP</strong>，即任何时刻对<br>Zookeeper 的访问请求能得到一致的数据结果，同时系统对网络分割具备容错性，但是它不能保证每次服务请求的可用性。从实际情况来分析，在使用 Zookeeper 获取服务列表时，如果 zookeeper 正在选主，或者 Zookeeper 集群中半数以上机器不可用，那么将就无法获得数据了。所以说，Zookeeper 不能保证服务可用性。</p>
<p>诚然，对于大多数分布式环境，尤其是涉及到数据存储的场景，数据一致性应该是首先被保证的，这也是 zookeeper 设计成 CP 的原因。但是对于服务发现场景来说，情况就不太一样了：针对同一个服务，即使注册中心的不同节点保存的服务提供者信息不尽相同，也并不会造成灾难性的后果。因为对于服务消费者来说，能消费才是最重要的——拿到可能不正确的服务实例信息后尝试消费一下，也好过因为无法获取实例信息而不去消费。<strong>所以，对于服务发现而言，可用性比数据一致性更加重要——AP 胜过 CP</strong>。而 Spring Cloud Netflix 在设计 Eureka 时遵守的就是 AP 原则。</p>
<p>Eureka 本身是 Netflix 开源的一款提供服务注册和发现的产品，并且提供了相应的 Java 封装。在它的实现中，节点之间是相互平等的，部分注册中心的节点挂掉也不会对集群造成影响，即使集群只剩一个节点存活，也可以正常提供发现服务。哪怕是所有的服务注册节点都挂了，Eureka Clients 上也会缓存服务调用的信息。这就保证了我们微服务之间的互相调用是足够健壮的。</p>
<p>除此之外，Spring Cloud Netflix 背后强大的开源力量，也促使我们选择了 Spring Cloud Netflix：</p>
<ul>
<li>前文提到过，Spring Cloud 的社区十分活跃，其在业界的应用也十分广泛（尤其是国外），而且整个框架也经受住了 Netflix 严酷生产环境的考验。</li>
<li>除了服务注册和发现，Spring Cloud Netflix 的其他功能也十分强大，包括 Ribbon，hystrix，Feign，Zuul 等组件，结合到一起，让服务的调用、路由也变得异常容易。</li>
<li>Spring Cloud Netflix 作为 Spring 的重量级整合框架，使用它也意味着我们能从 Spring 获取到巨大的便利。Spring Cloud 的其他子项目，比如 Spring Cloud Stream、Spring Cloud Config 等等，都为微服务的各种需求提供了一站式的解决方案。</li>
</ul>
<h1 id="3-Spring-Cloud-服务发现"><a href="#3-Spring-Cloud-服务发现" class="headerlink" title="3. Spring Cloud 服务发现"></a>3. Spring Cloud 服务发现</h1><p>Spring Cloud Netflix 的核心是用于服务注册与发现的 Eureka，接下来我们将以 Eureka 为线索，介绍 Eureka、Ribbon、Hystrix、Feign 这些 Spring Cloud Netflix 主要组件。</p>
<h2 id="3-1-服务注册与发现——Eureka"><a href="#3-1-服务注册与发现——Eureka" class="headerlink" title="3.1 服务注册与发现——Eureka"></a>3.1 服务注册与发现——Eureka</h2><blockquote>
<p>Eureka 这个词来源于古希腊语，意为 “我找到了！我发现了！”，据传，阿基米德在洗澡时发现浮力原理，高兴得来不及穿上裤子，跑到街上大喊：“Eureka(我找到了)！”。</p>
</blockquote>
<p>Eureka 由多个 instance(服务实例) 组成，这些服务实例可以分为两种：Eureka Server 和 Eureka Client。为了便于理解，我们将 Eureka client 再分为 Service Provider 和 Service Consumer。如下图所示：</p>
<p><img src="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-微服务架构的服务与发现_-_Spring_Cloud/image3" alt=""></p>
<ul>
<li>Eureka Server：服务的注册中心，负责维护注册的服务列表。</li>
<li>Service Provider：服务提供方，作为一个 Eureka Client，向 Eureka Server 做服务注册、续约和下线等操作，注册的主要数据包括服务名、机器 ip、端口号、域名等等。</li>
<li>Service Consumer：服务消费方，作为一个 Eureka Client，向 Eureka Server 获取 Service Provider 的注册信息，并通过远程调用与 Service Provider 进行通信。</li>
</ul>
<blockquote>
<p>Service Provider 和 Service Consumer 不是严格的概念，Service Consumer 也可以随时向 Eureka Server 注册，来让自己变成一个 Service Provider。</p>
</blockquote>
<hr>
<blockquote>
<p>Spring Cloud 针对服务注册与发现，进行了一层抽象，并提供了三种实现：Eureka、Consul、Zookeeper。目前支持得最好的就是 Eureka，其次是 Consul，最后是 Zookeeper。</p>
</blockquote>
<h3 id="3-1-1-Eureka-Server"><a href="#3-1-1-Eureka-Server" class="headerlink" title="3.1.1 Eureka Server"></a>3.1.1 Eureka Server</h3><p>Eureka Server 作为一个独立的部署单元，以 REST API 的形式为服务实例提供了注册、管理和查询等操作。同时，Eureka Server 也为我们提供了可视化的监控页面，可以直观地看到各个 Eureka Server 当前的运行状态和所有已注册服务的情况。</p>
<h4 id="3-1-1-1-Eureka-Server-的高可用集群"><a href="#3-1-1-1-Eureka-Server-的高可用集群" class="headerlink" title="3.1.1.1 Eureka Server 的高可用集群"></a>3.1.1.1 Eureka Server 的高可用集群</h4><p>Eureka Server 可以运行多个实例来构建集群，解决单点问题，但不同于 ZooKeeper 的选举 leader 的过程，Eureka Server 采用的是 Peer to Peer 对等通信。这是一种去中心化的架构，无 master/slave 区分，每一个 Peer 都是对等的。在这种架构中，节点通过彼此互相注册来提高可用性，每个节点需要添加一个或多个有效的 serviceUrl 指向其他节点。每个节点都可被视为其他节点的副本。</p>
<p>如果某台 Eureka Server 宕机，Eureka Client 的请求会自动切换到新的 Eureka Server 节点，当宕机的服务器重新恢复后，Eureka 会再次将其纳入到服务器集群管理之中。当节点开始接受客户端请求时，所有的操作都会进行 replicateToPeer（节点间复制）操作，将请求复制到其他 Eureka Server 当前所知的所有节点中。</p>
<p>一个新的 Eureka Server 节点启动后，会首先尝试从邻近节点获取所有实例注册表信息，完成初始化。Eureka Server 通过 getEurekaServiceUrls() 方法获取所有的节点，并且会通过心跳续约的方式定期更新。默认配置下，如果 Eureka Server 在一定时间内没有接收到某个服务实例的心跳，Eureka Server 将会注销该实例（默认为 90 秒，通过 eureka.instance.lease-expiration-duration-in-seconds 配置）。当 Eureka Server 节点在短时间内丢失过多的心跳时（比如发生了网络分区故障），那么这个节点就会进入自我保护模式。下图为 Eureka 官网的架构图</p>
<blockquote>
<p>什么是自我保护模式？默认配置下，如果 Eureka Server 每分钟收到心跳续约的数量低于一个阈值（instance 的数量 <em>(60 / 每个 instance 的心跳间隔秒数)</em> 自我保护系数），就会触发自我保护。在自我保护模式中，Eureka Server 会保护服务注册表中的信息，不再注销任何服务实例。当它收到的心跳数重新恢复到阈值以上时，该 Eureka Server 节点就会自动退出自我保护模式。它的设计哲学前面提到过，那就是宁可保留错误的服务注册信息，也不盲目注销任何可能健康的服务实例。该模式可以通过 eureka.server.enable-self-preservation = false 来禁用，同时 eureka.instance.lease-renewal-interval-in-seconds 可以用来更改心跳间隔，eureka.server.renewal-percent-threshold 可以用来修改自我保护系数（默认 0.85）。</p>
</blockquote>
<p><img src="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-微服务架构的服务与发现_-_Spring_Cloud/image4" alt=""></p>
<h4 id="3-1-1-2-Eureka-Server-的-Region、Zone"><a href="#3-1-1-2-Eureka-Server-的-Region、Zone" class="headerlink" title="3.1.1.2 Eureka Server 的 Region、Zone"></a>3.1.1.2 Eureka Server 的 Region、Zone</h4><p>Eureka 的官方文档对 Regin、Zone 几乎没有提及，由于概念抽象，新手很难理解。因此，我们先来了解一下 Region、Zone、Eureka 集群三者的关系，如下图所示：</p>
<p><img src="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-微服务架构的服务与发现_-_Spring_Cloud/image5" alt=""></p>
<p>region 和 zone（或者 Availability Zone）均是 AWS 的概念。在非 AWS 环境下，我们可以先简单地将 region 理解为 Eureka 集群，zone 理解成机房。上图就可以理解为一个 Eureka 集群被部署在了 zone1 机房和 zone2 机房中。</p>
<h3 id="3-1-2-Service-Provider"><a href="#3-1-2-Service-Provider" class="headerlink" title="3.1.2 Service Provider"></a>3.1.2 Service Provider</h3><h4 id="3-1-2-1-服务注册"><a href="#3-1-2-1-服务注册" class="headerlink" title="3.1.2.1 服务注册"></a>3.1.2.1 服务注册</h4><p>Service Provider 本质上是一个 Eureka Client。它启动时，会调用服务注册方法，向 Eureka Server 注册自己的信息。Eureka Server 会维护一个已注册服务的列表，这个列表为一个嵌套的 hash map：</p>
<ul>
<li>第一层，application name 和对应的服务实例。</li>
<li>第二层，服务实例及其对应的注册信息，包括 IP，端口号等。</li>
</ul>
<p>当实例状态发生变化时（如自身检测认为 Down 的时候），也会向 Eureka Server 更新自己的服务状态，同时用 replicateToPeers() 向其它 Eureka Server 节点做状态同步。</p>
<p><img src="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-微服务架构的服务与发现_-_Spring_Cloud/image6" alt=""></p>
<h4 id="3-1-2-2-续约与剔除"><a href="#3-1-2-2-续约与剔除" class="headerlink" title="3.1.2.2 续约与剔除"></a>3.1.2.2 续约与剔除</h4><p>前面提到过，服务实例启动后，会周期性地向 Eureka Server 发送心跳以续约自己的信息，避免自己的注册信息被剔除。续约的方式与服务注册基本一致：首先更新自身状态，再同步到其它 Peer。</p>
<p>如果 Eureka Server 在一段时间内没有接收到某个微服务节点的心跳，Eureka Server 将会注销该微服务节点（自我保护模式除外）。</p>
<p><img src="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-微服务架构的服务与发现_-_Spring_Cloud/image7" alt=""></p>
<h3 id="3-1-3-Service-Consumer"><a href="#3-1-3-Service-Consumer" class="headerlink" title="3.1.3 Service Consumer"></a>3.1.3 Service Consumer</h3><p>Service Consumer 本质上也是一个 Eureka Client（它也会向 Eureka Server 注册，只是这个注册信息无关紧要罢了）。它启动后，会从 Eureka Server 上获取所有实例的注册信息，包括 IP 地址、端口等，并缓存到本地。这些信息默认每 30 秒更新一次。前文提到过，如果与 Eureka Server 通信中断，Service Consumer 仍然可以通过本地缓存与 Service Provider 通信。</p>
<p>实际开发 Eureka 的过程中，有时会遇见 Service Consumer 获取到 Server Provider 的信息有延迟，在 <a href="https://link.jianshu.com?t=https://github.com/Netflix/eureka/wiki/Understanding-eureka-client-server-communication" target="_blank" rel="noopener">Eureka Wiki</a> 中有这么一段话:</p>
<blockquote>
<p>All operations from Eureka client may take some time to reflect in the Eureka servers and subsequently in other Eureka clients. This is because of the caching of the payload on the eureka server which is refreshed periodically to reflect new information. Eureka clients also fetch deltas periodically. Hence, it may take up to 2 mins for changes to propagate to all Eureka clients.</p>
</blockquote>
<p>最后一句话提到，服务端的更改可能需要 2 分钟才能传播到所有客户端，至于原因并没有介绍。这是因为 Eureka 有三处缓存和一处延迟造成的。</p>
<ul>
<li>Eureka Server 对注册列表进行缓存，默认时间为 30s。</li>
<li>Eureka Client 对获取到的注册信息进行缓存，默认时间为 30s。</li>
<li>Ribbon 会从上面提到的 Eureka Client 获取服务列表，将负载均衡后的结果缓存 30s。</li>
<li>如果不是在 Spring Cloud 环境下使用这些组件 (Eureka, Ribbon)，服务启动后并不会马上向 Eureka 注册，而是需要等到第一次发送心跳请求时才会注册。心跳请求的发送间隔默认是 30s。Spring Cloud 对此做了修改，服务启动后会马上注册。</li>
</ul>
<p>基于 Service Consumer 获取到的服务实例信息，我们就可以进行服务调用了。而 Spring Cloud 也为 Service Consumer 提供了丰富的服务调用工具：</p>
<ul>
<li>Ribbon，实现客户端的负载均衡。</li>
<li>Hystrix，断路器。</li>
<li>Feign，RESTful Web Service 客户端，整合了 Ribbon 和 Hystrix。</li>
</ul>
<p>接下来我们就一一介绍。</p>
<h2 id="3-2-服务调用端负载均衡——Ribbon"><a href="#3-2-服务调用端负载均衡——Ribbon" class="headerlink" title="3.2 服务调用端负载均衡——Ribbon"></a>3.2 服务调用端负载均衡——Ribbon</h2><p>Ribbon 是 Netflix 发布的开源项目，主要功能是为 REST 客户端实现负载均衡。它主要包括六个组件：</p>
<ul>
<li>ServerList，负载均衡使用的服务器列表。这个列表会缓存在负载均衡器中，并定期更新。当 Ribbon 与 Eureka 结合使用时，ServerList 的实现类就是 DiscoveryEnabledNIWSServerList，它会保存 Eureka Server 中注册的服务实例表。</li>
<li>ServerListFilter，服务器列表过滤器。这是一个接口，主要用于对 Service Consumer 获取到的服务器列表进行预过滤，过滤的结果也是 ServerList。Ribbon 提供了多种过滤器的实现。</li>
<li>IPing，探测服务实例是否存活的策略。</li>
<li>IRule，负载均衡策略，其实现类表述的策略包括：轮询、随机、根据响应时间加权等。</li>
</ul>
<blockquote>
<p>我们也可以自己定义负载均衡策略，比如我们就利用自己实现的策略，实现了服务的版本控制和直连配置。实现好之后，将实现类重新注入到 Ribbon 中即可。</p>
</blockquote>
<ul>
<li>ILoadBalancer，负载均衡器。这也是一个接口，Ribbon 为其提供了多个实现，比如 ZoneAwareLoadBalancer。而上层代码通过调用其 API 进行服务调用的负载均衡选择。一般 ILoadBalancer 的实现类中会引用一个 IRule。</li>
<li>RestClient，服务调用器。顾名思义，这就是负载均衡后，Ribbon 向 Service Provider 发起 REST 请求的工具。</li>
</ul>
<p>Ribbon 工作时会做四件事情：</p>
<ol>
<li>优先选择在同一个 Zone 且负载较少的 Eureka Server；</li>
<li>定期从 Eureka 更新并过滤服务实例列表；</li>
<li>根据用户指定的策略，在从 Server 取到的服务注册列表中选择一个实例的地址；</li>
<li>通过 RestClient 进行服务调用。</li>
</ol>
<h2 id="3-3-服务调用端熔断——Hystrix"><a href="#3-3-服务调用端熔断——Hystrix" class="headerlink" title="3.3 服务调用端熔断——Hystrix"></a>3.3 服务调用端熔断——Hystrix</h2><p>Netflix 创建了一个名为 Hystrix 的库, 实现了断路器的模式。“断路器” 本身是一种开关装置，当某个服务单元发生故障之后，通过断路器的故障监控（类似熔断保险丝），向调用方返回一个符合预期的、可处理的备选响应（FallBack），而不是长时间的等待或者抛出调用方无法处理的异常，这样就保证了服务调用方的线程不会被长时间、不必要地占用，从而避免了故障在分布式系统中的蔓延，乃至雪崩。</p>
<p><img src="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-微服务架构的服务与发现_-_Spring_Cloud/image8" alt=""></p>
<p>当然，在请求失败频率较低的情况下，Hystrix 还是会直接把故障返回给客户端。只有当失败次数达到阈值（默认在 20 秒内失败 5 次）时，断路器打开并且不进行后续通信，而是直接返回备选响应。当然，Hystrix 的备选响应也是可以由开发者定制的。</p>
<p><img src="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-微服务架构的服务与发现_-_Spring_Cloud/image9" alt=""></p>
<p>除了隔离依赖服务的调用以外，Hystrix 还提供了准实时的调用监控（<strong>Hystrix Dashboard</strong>），Hystrix 会持续地记录所有通过 Hystrix 发起的请求的执行信息，并以统计报表和图形的形式展示给用户，包括每秒执行多少请求多少成功，多少失败等。Netflix 通过 hystrix-metrics-event-stream 项目实现了对以上指标的监控。Spring Cloud 也提供了 Hystrix Dashboard 的整合，对监控内容转化成可视化界面，<a href="https://link.jianshu.com?t=https://github.com/Netflix/Hystrix/wiki/Dashboard" target="_blank" rel="noopener">Hystrix Dashboard Wiki</a> 上详细说明了图上每个指标的含义。</p>
<p><img src="http://p4lmrb1gp.bkt.clouddn.com/20180526_simpread-微服务架构的服务与发现_-_Spring_Cloud/image10" alt=""></p>
<h2 id="3-4-服务调用端代码抽象和封装——Feign"><a href="#3-4-服务调用端代码抽象和封装——Feign" class="headerlink" title="3.4 服务调用端代码抽象和封装——Feign"></a>3.4 服务调用端代码抽象和封装——Feign</h2><p>Feign 是一个声明式的 Web Service 客户端，它的目的就是让 Web Service 调用更加简单。它整合了 Ribbon 和 Hystrix，从而让我们不再需要显式地使用这两个组件。Feign 还提供了 HTTP 请求的模板，通过编写简单的接口和插入注解，我们就可以定义好 HTTP 请求的参数、格式、地址等信息。接下来，Feign 会完全代理 HTTP 的请求，我们只需要像调用方法一样调用它就可以完成服务请求。</p>
<p>Feign 具有如下特性：</p>
<ul>
<li>可插拔的注解支持，包括 Feign 注解和 JAX-RS 注解</li>
<li>支持可插拔的 HTTP 编码器和解码器</li>
<li>支持 Hystrix 和它的 Fallback</li>
<li>支持 Ribbon 的负载均衡</li>
<li>支持 HTTP 请求和响应的压缩</li>
</ul>
<p>以下是一个 Feign 的简单示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableDiscoveryClient //启用Feign</span><br><span class="line">@EnableFeignClients</span><br><span class="line">public class Application</span><br><span class="line">&#123;</span><br><span class="line">    public static void main(String[] args)</span><br><span class="line">    &#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@FeignClient(name = &quot;elements&quot;, fallback = ElementsFallback.class) //指定feign调用的服务和Hystrix Fallback（name即eureka的application name）</span><br><span class="line">public interface Elements</span><br><span class="line">&#123;</span><br><span class="line">    @RequestMapping(value = &quot;/index&quot;)</span><br><span class="line">    String index();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//Hystrix Fallback  </span><br><span class="line">@Component</span><br><span class="line">public class ElementsFallback implements Elements</span><br><span class="line">&#123;</span><br><span class="line">    @Override</span><br><span class="line">    public String index()</span><br><span class="line">    &#123;</span><br><span class="line">        return &quot;**************&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//测试类</span><br><span class="line">@Component  </span><br><span class="line">public class TestController &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    Elements elements;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(value = &quot;/testEureka&quot;, method = RequestMethod.GET)</span><br><span class="line">    public String testeureka()</span><br><span class="line">    &#123;</span><br><span class="line">        return elements.index();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<blockquote>
<p>参考：<br>Spring Cloud技术分析（序） | 网易乐得技术团队<br><a href="http://tech.lede.com/2017/03/15/rd/server/SpringCloud0/" target="_blank" rel="noopener">http://tech.lede.com/2017/03/15/rd/server/SpringCloud0/</a><br>微服务架构的服务与发现-Spring Cloud - 简书<br><a href="https://www.jianshu.com/p/5eac16e9804a" target="_blank" rel="noopener">https://www.jianshu.com/p/5eac16e9804a</a></p>
</blockquote>

      
    </div>
    
    
    


     
    
      <div>
        
    <div style="text-align:center;color: #ccc;font-size:14px;">
        ------ 本文结束<i class="fa fa-paw"></i>感谢您的阅读 ------</div>

      </div>
    


    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    CloudPai
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://cloudpai.site/2018/05/26/2018-05-26-1/" title="Spring Cloud 技术分析:Netflix 组件">http://cloudpai.site/2018/05/26/2018-05-26-1/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    




    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/SpringCloud/" rel="tag"><i class="fa fa-tag"></i> SpringCloud</a>
          
            <a href="/tags/Netflix/" rel="tag"><i class="fa fa-tag"></i> Netflix</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/05/26/2018-05-26/" rel="next" title="Spring Cloud构建微服务架构：服务注册与发现（Eureka、Consul）【Dalston版】实操笔记">
                <i class="fa fa-chevron-left"></i> Spring Cloud构建微服务架构：服务注册与发现（Eureka、Consul）【Dalston版】实操笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>




  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="http://p4lmrb1gp.bkt.clouddn.com/君名-squashed.jpg"
                alt="CloudPai" />
            
              <p class="site-author-name" itemprop="name">CloudPai</p>
              <p class="site-description motion-element" itemprop="description">加油(๑•̀ㅂ•́)و✧加油</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">236</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            


<div id="music163player">
    <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=280 height=240 src="//music.163.com/outchain/player?type=0&id=2113726971&auto=0&height=430"></iframe>
</div>
<!-- 459004290 -->




            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">118</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/CloudPai" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:liupai024@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.douban.com/people/57965969/doulists/all" target="_blank" title="豆瓣">
                      
                        <i class="fa fa-fw fa-book"></i>豆瓣</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/cloudPai/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-edit"></i>知乎</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.dlut.edu.cn/" title="DUT" target="_blank">DUT</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.bupt.edu.cn/" title="BUPT" target="_blank">BUPT</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://campus.alibaba.com/index.htm" title="Alibaba Group" target="_blank">Alibaba Group</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-为什么微服务架构需要-Spring-Cloud"><span class="nav-text">1 为什么微服务架构需要 Spring Cloud</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-从使用-nginx-说起"><span class="nav-text">1.1 从使用 nginx 说起</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-基于-Dubbo-实现微服务"><span class="nav-text">1.2 基于 Dubbo 实现微服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-新的选择——Spring-Cloud"><span class="nav-text">1.3 新的选择——Spring Cloud</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-Spring-Cloud-技术概览"><span class="nav-text">2 Spring Cloud 技术概览</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-Spring-Cloud-Netflix-组件"><span class="nav-text">2. Spring Cloud Netflix 组件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-Spring-Cloud-服务发现"><span class="nav-text">3. Spring Cloud 服务发现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-服务注册与发现——Eureka"><span class="nav-text">3.1 服务注册与发现——Eureka</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-Eureka-Server"><span class="nav-text">3.1.1 Eureka Server</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-1-Eureka-Server-的高可用集群"><span class="nav-text">3.1.1.1 Eureka Server 的高可用集群</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-2-Eureka-Server-的-Region、Zone"><span class="nav-text">3.1.1.2 Eureka Server 的 Region、Zone</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-2-Service-Provider"><span class="nav-text">3.1.2 Service Provider</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-2-1-服务注册"><span class="nav-text">3.1.2.1 服务注册</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-2-2-续约与剔除"><span class="nav-text">3.1.2.2 续约与剔除</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-3-Service-Consumer"><span class="nav-text">3.1.3 Service Consumer</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-服务调用端负载均衡——Ribbon"><span class="nav-text">3.2 服务调用端负载均衡——Ribbon</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-服务调用端熔断——Hystrix"><span class="nav-text">3.3 服务调用端熔断——Hystrix</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-服务调用端代码抽象和封装——Feign"><span class="nav-text">3.4 服务调用端代码抽象和封装——Feign</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CloudPai</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">915.3k</span>
  
</div>




<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv">  </span>
</span>
</div>







  <div class="theme-info">&#12288;主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://cloudpai.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://cloudpai.site/2018/05/26/2018-05-26-1/';
          this.page.identifier = '2018/05/26/2018-05-26-1/';
          this.page.title = 'Spring Cloud 技术分析:Netflix 组件';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://cloudpai.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  <!-- <!-- <script src="https://cdn.bootcss.com/aplayer/1.6.0/APlayer.min.js"></script>

<script src="https://api.i-meto.com/music/player.js"></script> --> -->
  
  <!--移动端判断，是否引入背景-->
  <script>
  var browser={  
      versions:function(){   
             var u = navigator.userAgent, app = navigator.appVersion;   
             return {//移动终端浏览器版本信息
                  trident: u.indexOf('Trident') > -1, //IE内核
                  presto: u.indexOf('Presto') > -1, //opera内核
                  webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
                  gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
                  mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
                  ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
                  android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
                  iPhone: u.indexOf('iPhone') > -1 , //是否为iPhone或者QQHD浏览器
                  iPad: u.indexOf('iPad') > -1, //是否iPad
                  webApp: u.indexOf('Safari') == -1 //是否web应该程序，没有头部与底部
              };  
           }(),  
           language:(navigator.browserLanguage || navigator.language).toLowerCase()  
  }   
    if(browser.versions.mobile || browser.versions.ios || browser.versions.android ||   
      browser.versions.iPhone || browser.versions.iPad){        
               
    }else{
    document.write("<script type=\'text/javascript\'  src=\'/js/src/particle.js\'><\/script>");
    }
  </script>

  
<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"right","hOffset":-80,"vOffset":-50},"mobile":{"show":false,"scale":0.2},"react":{"opacityDefault":1,"opacityOnHover":0.2}});</script></body>
</html>
