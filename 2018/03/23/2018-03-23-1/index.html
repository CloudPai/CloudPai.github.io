<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/favicon.ico?v=5.1.4" color="#222">





  <meta name="keywords" content="java,并发," />





  <link rel="alternate" href="/atom.xml" title="CloudPai" type="application/atom+xml" />






<meta name="description" content="01 基本概念多线程是 Java 中不可避免的一个重要主体。从本章开始，我们将展开对多线程的学习。接下来的内容，是对 “JDK 中新增 JUC 包” 之前的 Java 多线程内容的讲解，涉及到的内容包括，Object 类中的 wait(), notify()等接口；Thread 类中的接口；synchronized 关键字。 注：JUC 包是指，Java.util.concurrent 包，它是">
<meta name="keywords" content="java,并发">
<meta property="og:type" content="article">
<meta property="og:title" content="java多线程系列一：基础篇">
<meta property="og:url" content="http://cloudpai.site/2018/03/23/2018-03-23-1/index.html">
<meta property="og:site_name" content="CloudPai">
<meta property="og:description" content="01 基本概念多线程是 Java 中不可避免的一个重要主体。从本章开始，我们将展开对多线程的学习。接下来的内容，是对 “JDK 中新增 JUC 包” 之前的 Java 多线程内容的讲解，涉及到的内容包括，Object 类中的 wait(), notify()等接口；Thread 类中的接口；synchronized 关键字。 注：JUC 包是指，Java.util.concurrent 包，它是">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://p4lmrb1gp.bkt.clouddn.com/15218146020378.jpg">
<meta property="og:image" content="http://p4lmrb1gp.bkt.clouddn.com/15219001605934.png">
<meta property="og:image" content="http://p4lmrb1gp.bkt.clouddn.com/15219001769486.png">
<meta property="og:image" content="http://p4lmrb1gp.bkt.clouddn.com/15219002092499.png">
<meta property="og:image" content="http://p4lmrb1gp.bkt.clouddn.com/15219002479692.png">
<meta property="og:updated_time" content="2018-03-24T14:04:30.936Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="java多线程系列一：基础篇">
<meta name="twitter:description" content="01 基本概念多线程是 Java 中不可避免的一个重要主体。从本章开始，我们将展开对多线程的学习。接下来的内容，是对 “JDK 中新增 JUC 包” 之前的 Java 多线程内容的讲解，涉及到的内容包括，Object 类中的 wait(), notify()等接口；Thread 类中的接口；synchronized 关键字。 注：JUC 包是指，Java.util.concurrent 包，它是">
<meta name="twitter:image" content="http://p4lmrb1gp.bkt.clouddn.com/15218146020378.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'TZAS2SFOJR',
      apiKey: 'e2a9cd036eede8026382b302001ec261',
      indexName: 'cloudpai_blogs_search',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://cloudpai.site/2018/03/23/2018-03-23-1/"/>





  <title>java多线程系列一：基础篇 | CloudPai</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-114643720-1', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">CloudPai</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">个人博客</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            时间轴
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>




 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://cloudpai.site/2018/03/23/2018-03-23-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CloudPai">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p4lmrb1gp.bkt.clouddn.com/君名-squashed.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CloudPai">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">java多线程系列一：基础篇</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-23T22:14:48+08:00">
                2018-03-23
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-03-24T22:04:30+08:00">
                2018-03-24
              </time>
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/23/2018-03-23-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/03/23/2018-03-23-1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  17,596
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  80
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <script src="/assets/js/APlayer.min.js"> </script><h1 id="01-基本概念"><a href="#01-基本概念" class="headerlink" title="01 基本概念"></a>01 基本概念</h1><p>多线程是 Java 中不可避免的一个重要主体。从本章开始，我们将展开对多线程的学习。接下来的内容，是对 “JDK 中新增 JUC 包” 之前的 Java 多线程内容的讲解，涉及到的内容包括，Object 类中的 wait(), notify()等接口；Thread 类中的接口；synchronized 关键字。</p>
<p>注：<em>JUC 包是指，Java.util.concurrent 包，它是由 Java 大师 Doug Lea 完成并在 JDK1.5 版本添加到 Java 中的</em></p>
<p>在进入后面章节的学习之前，先了解一些多线程的相关概念。<br>线程状态图</p>
<p><img src="http://p4lmrb1gp.bkt.clouddn.com/15218146020378.jpg" alt=""></p>
<p><strong>说明</strong>：<br>线程共包括以下 5 种状态。<br>1. <strong>新建状态 (New)         </strong>: 线程对象被创建后，就进入了新建状态。例如，Thread thread = new Thread()。<br>2. <strong>就绪状态 (Runnable)</strong>: 也被称为 “可执行状态”。线程对象被创建后，其它线程调用了该对象的 start() 方法，从而来启动该线程。例如，thread.start()。处于就绪状态的线程，随时可能被 CPU 调度执行。<br>3. <strong>运行状态 (Running)</strong> : 线程获取 CPU 权限进行执行。需要注意的是，<strong>线程只能从就绪状态进入到运行状态。</strong><br>4. <strong>阻塞状态 (Blocked) </strong> : 阻塞状态是线程因为某种原因放弃 CPU 使用权，暂时停止运行。直到线程进入就绪状态，才有机会转到运行状态。阻塞的情况分三种：<br>    (01) 等待阻塞 – 通过调用线程的 wait() 方法，让线程等待某工作的完成。<br>    (02) 同步阻塞 – 线程在获取 synchronized 同步锁失败 (因为锁被其它线程所占用)，它会进入同步阻塞状态。<br>    (03) 其他阻塞 – 通过调用线程的 sleep() 或 join() 或发出了 I/O 请求时，线程会进入到阻塞状态。当 sleep() 状态超时、join() 等待线程终止或者超时、或者 I/O 处理完毕时，线程重新转入就绪状态。<br>5. <strong>死亡状态 (Dead)</strong>    : 线程执行完了或者因异常退出了 run() 方法，该线程结束生命周期。</p>
<p>这 5 种状态涉及到的内容包括 Object 类, Thread 和 synchronized 关键字。这些内容我们会在后面的章节中逐个进行学习。<br><strong>Object 类</strong>，定义了 wait(), notify(), notifyAll() 等休眠 / 唤醒函数。<br><strong>Thread 类</strong>，定义了一些列的线程操作函数。例如，sleep() 休眠函数, interrupt() 中断函数, getName() 获取线程名称等。<br><strong>synchronized</strong>，是关键字；它区分为 synchronized 代码块和 synchronized 方法。<strong>synchronized 的作用是让线程获取对象的同步锁</strong>。<br>在后面详细介绍 wait(),notify()等方法时，我们会分析为什么 “wait(), notify() 等方法要定义在 Object 类，而不是 Thread 类中”。</p>
<h1 id="02-常用的实现多线程的两种方式"><a href="#02-常用的实现多线程的两种方式" class="headerlink" title="02 常用的实现多线程的两种方式"></a>02 常用的实现多线程的两种方式</h1><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a><strong>概要</strong></h2><p>本章，我们学习 “常用的实现多线程的 2 种方式”：<strong>Thread</strong> 和 <strong>Runnable</strong>。<br>之所以说是常用的，是因为通过还可以通过 java.util.concurrent 包中的线程池来实现多线程。关于线程池的内容，我们以后会详细介绍；现在，先对的 Thread 和 Runnable 进行了解。本章内容包括：<br><strong>Thread 和 Runnable 的简介</strong><br><strong>Thread 和 Runnable 的异同点</strong><br><strong>Thread 和 Runnable 的多线程的示例</strong></p>
<h2 id="Thread-和-Runnable-简介"><a href="#Thread-和-Runnable-简介" class="headerlink" title="Thread 和 Runnable 简介"></a><strong><a></a>Thread 和 Runnable 简介</strong></h2><p><strong>Runnable</strong> 是一个<strong>接口</strong>，该接口中只包含了一个 run() 方法。它的定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Runnable 的作用，实现多线程。我们可以定义一个类 A 实现 Runnable 接口；然后，通过 new Thread(new A()) 等方式新建线程。</p>
<p><strong>Thread</strong> 是一个<strong>类</strong>。Thread 本身就实现了 Runnable 接口。它的声明如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Thread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>Thread 的作用，实现多线程。</p>
<h2 id="Thread-和-Runnable-的异同点"><a href="#Thread-和-Runnable-的异同点" class="headerlink" title="Thread 和 Runnable 的异同点"></a><strong><a></a>Thread 和 Runnable 的异同点</strong></h2><p><strong>Thread 和 Runnable 的相同点</strong>：都是 “多线程的实现方式”。<br><strong>Thread 和 Runnable 的不同点</strong>：<br>Thread 是类，而 Runnable 是接口；Thread 本身是实现了 Runnable 接口的类。我们知道 “一个类只能有一个父类，但是却能实现多个接口”，因此 Runnable 具有更好的扩展性。<br>此外，Runnable 还可以用于 “资源的共享”。即，多个线程都是基于某一个 Runnable 对象建立的，它们会共享 Runnable 对象上的资源。<br>通常，<strong>建议通过 “Runnable” 实现多线程</strong>！</p>
<h2 id="Thread-和-Runnable-的多线程示例"><a href="#Thread-和-Runnable-的多线程示例" class="headerlink" title="Thread 和 Runnable 的多线程示例"></a><strong><a></a>Thread 和 Runnable 的多线程示例</strong></h2><h3 id="1-Thread-的多线程示例"><a href="#1-Thread-的多线程示例" class="headerlink" title="1. Thread 的多线程示例"></a>1. Thread 的多线程示例</h3><p>下面通过示例更好的理解 Thread 和 Runnable，借鉴网上一个例子比较具有说服性的例子。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ThreadTest.java 源码</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> ticket=<span class="number">10</span>;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">20</span>;i++)&#123; </span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.ticket&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                System.out.println(<span class="keyword">this</span>.getName()+<span class="string">" 卖票：ticket"</span>+<span class="keyword">this</span>.ticket--);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadTest</span> </span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line">        <span class="comment">// 启动3个线程t1,t2,t3；每个线程各卖10张票！</span></span><br><span class="line">        MyThread t1=<span class="keyword">new</span> MyThread();</span><br><span class="line">        MyThread t2=<span class="keyword">new</span> MyThread();</span><br><span class="line">        MyThread t3=<span class="keyword">new</span> MyThread();</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t3.start();</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Thread-0 卖票：ticket10</span><br><span class="line">Thread-1 卖票：ticket10</span><br><span class="line">Thread-2 卖票：ticket10</span><br><span class="line">Thread-1 卖票：ticket9</span><br><span class="line">Thread-0 卖票：ticket9</span><br><span class="line">Thread-1 卖票：ticket8</span><br><span class="line">Thread-2 卖票：ticket9</span><br><span class="line">Thread-1 卖票：ticket7</span><br><span class="line">Thread-0 卖票：ticket8</span><br><span class="line">Thread-1 卖票：ticket6</span><br><span class="line">Thread-2 卖票：ticket8</span><br><span class="line">Thread-1 卖票：ticket5</span><br><span class="line">Thread-0 卖票：ticket7</span><br><span class="line">Thread-1 卖票：ticket4</span><br><span class="line">Thread-2 卖票：ticket7</span><br><span class="line">Thread-1 卖票：ticket3</span><br><span class="line">Thread-0 卖票：ticket6</span><br><span class="line">Thread-1 卖票：ticket2</span><br><span class="line">Thread-2 卖票：ticket6</span><br><span class="line">Thread-2 卖票：ticket5</span><br><span class="line">Thread-2 卖票：ticket4</span><br><span class="line">Thread-1 卖票：ticket1</span><br><span class="line">Thread-0 卖票：ticket5</span><br><span class="line">Thread-2 卖票：ticket3</span><br><span class="line">Thread-0 卖票：ticket4</span><br><span class="line">Thread-2 卖票：ticket2</span><br><span class="line">Thread-0 卖票：ticket3</span><br><span class="line">Thread-2 卖票：ticket1</span><br><span class="line">Thread-0 卖票：ticket2</span><br><span class="line">Thread-0 卖票：ticket1</span><br></pre></td></tr></table></figure>
<p><strong>结果说明</strong>：</p>
<p>(01) MyThread 继承于 Thread，它是自定义个线程。每个 MyThread 都会卖出 10 张票。<br>(02) 主线程 main 创建并启动 3 个 MyThread 子线程。每个子线程都各自卖出了 10 张票。</p>
<h3 id="2-Runnable-的多线程示例"><a href="#2-Runnable-的多线程示例" class="headerlink" title="2. Runnable 的多线程示例"></a>2. Runnable 的多线程示例</h3><p>下面，我们对上面的程序进行修改。通过 Runnable 实现一个接口，从而实现多线程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RunnableTest.java 源码</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> ticket=<span class="number">10</span>;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">20</span>;i++)&#123; </span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.ticket&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" 卖票：ticket"</span>+<span class="keyword">this</span>.ticket--);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RunnableTest</span> </span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line">        MyThread mt=<span class="keyword">new</span> MyThread();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动3个线程t1,t2,t3(它们共用一个Runnable对象)，这3个线程一共卖10张票！</span></span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(mt);</span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(mt);</span><br><span class="line">        Thread t3=<span class="keyword">new</span> Thread(mt);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t3.start();</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Thread-0 卖票：ticket10</span><br><span class="line">Thread-2 卖票：ticket8</span><br><span class="line">Thread-1 卖票：ticket9</span><br><span class="line">Thread-2 卖票：ticket6</span><br><span class="line">Thread-0 卖票：ticket7</span><br><span class="line">Thread-2 卖票：ticket4</span><br><span class="line">Thread-1 卖票：ticket5</span><br><span class="line">Thread-2 卖票：ticket2</span><br><span class="line">Thread-0 卖票：ticket3</span><br><span class="line">Thread-1 卖票：ticket1</span><br></pre></td></tr></table></figure>
<p><strong>结果说明</strong>：<br>(01) 和上面 “MyThread 继承于 Thread” 不同；这里的 MyThread 实现了 Thread 接口。<br>(02) 主线程 main 创建并启动 3 个<strong>子线程</strong>，而且这 3 个子线程都是基于 “mt 这个 Runnable 对象” 而创建的。运行结果是这 3 个子线程一共卖出了 10 张票。这说明它们是共享了 MyThread 接口的。</p>
<hr>
<h1 id="03-Thread中start-和run-的区别"><a href="#03-Thread中start-和run-的区别" class="headerlink" title="03 Thread中start()和run()的区别"></a>03 Thread中start()和run()的区别</h1><h2 id="概要-1"><a href="#概要-1" class="headerlink" title="概要"></a><strong>概要</strong></h2><p>Thread 类包含 start() 和 run() 方法，它们的区别是什么？本章将对此作出解答。本章内容包括：<br><strong>start() 和 run() 的区别说明</strong><br><strong>start() 和 run() 的区别示例</strong><br><strong>start() 和 run() 相关源码 (基于 JDK1.7.0_40)</strong></p>
<h2 id="start-和-run-的区别说明"><a href="#start-和-run-的区别说明" class="headerlink" title="start() 和 run() 的区别说明"></a><strong><a></a>start() 和 run() 的区别说明</strong></h2><p><strong>start()</strong> : 它的作用是<strong>启动一个新线程</strong>，新线程会执行相应的 run() 方法。<strong>start() 不能被重复调用。</strong><br><strong>run()</strong>   : run() 就和普通的成员方法一样，可以被重复调用。单独调用 run() 的话，会在当前线程中执行 run()，而<strong>并不会启动新线程</strong>！</p>
<p>下面以代码来进行说明。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; </span><br><span class="line">&#125;;</span><br><span class="line">MyThread mythread = <span class="keyword">new</span> MyThread();</span><br></pre></td></tr></table></figure>
<p>mythread.start() 会启动一个新线程，并在新线程中运行 run() 方法。<br>而 mythread.run() 则会直接在当前线程中运行 run() 方法，并不会启动一个新线程来运行 run()。</p>
<h2 id="start-和-run-的区别示例"><a href="#start-和-run-的区别示例" class="headerlink" title="start() 和 run() 的区别示例"></a><strong><a></a>start() 和 run() 的区别示例</strong></h2><p>下面，通过一个简单示例演示它们之间的区别。源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Demo.java 的源码</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">" is running"</span>);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line">        Thread mythread=<span class="keyword">new</span> MyThread(<span class="string">"mythread"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">" call mythread.run()"</span>);</span><br><span class="line">        mythread.run();</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">" call mythread.start()"</span>);</span><br><span class="line">        mythread.start();</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">main call mythread.run()</span><br><span class="line">main is running</span><br><span class="line">main call mythread.start()</span><br><span class="line">mythread is running</span><br></pre></td></tr></table></figure>
<p><strong>结果说明</strong>：<br>(01) Thread.currentThread().getName()是用于获取 “当前线程” 的名字。当前线程是指正在 cpu 中调度执行的线程。<br>(02) mythread.run()是在 “主线程 main” 中调用的，该 run()方法直接运行在 “主线程 main” 上。<br>(03) mythread.start()会启动 “线程 mythread”，“线程 mythread” 启动之后，会调用 run()方法；此时的 run()方法是运行在 “线程 mythread” 上。</p>
<h2 id="start-和-run-相关源码-基于-JDK1-7-0-40"><a href="#start-和-run-相关源码-基于-JDK1-7-0-40" class="headerlink" title="start() 和 run() 相关源码 (基于 JDK1.7.0_40)"></a><strong><a></a>start() 和 run() 相关源码 (基于 JDK1.7.0_40)</strong></h2><p>Thread.java 中 start() 方法的源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 如果线程不是"就绪状态"，则抛出异常！</span></span><br><span class="line">    <span class="keyword">if</span> (threadStatus != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将线程添加到ThreadGroup中</span></span><br><span class="line">    group.add(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 通过start0()启动线程</span></span><br><span class="line">        start0();</span><br><span class="line">        <span class="comment">// 设置started标记</span></span><br><span class="line">        started = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!started) &#123;</span><br><span class="line">                group.threadStartFailed(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明</strong>：start() 实际上是通过<strong>本地方法</strong> start0() 启动线程的。而 start0() 会新运行一个线程，新线程会调用 run() 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">start0</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>Thread.java 中 run() 的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (target != <span class="keyword">null</span>) &#123;</span><br><span class="line">        target.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明</strong>：target 是一个 Runnable 对象。run() 就是直接调用 Thread 线程的 Runnable 成员的 run() 方法，并不会新建一个线程。</p>
<hr>
<h1 id="04-synchronized关键字"><a href="#04-synchronized关键字" class="headerlink" title="04 synchronized关键字"></a>04 synchronized关键字</h1><h2 id="概要-2"><a href="#概要-2" class="headerlink" title="概要"></a><strong>概要</strong></h2><p>本章，会对 synchronized 关键字进行介绍。涉及到的内容包括：<br><strong>1. synchronized 原理</strong><br><strong>2. synchronized 基本规则</strong><br><strong>3. synchronized 方法 和 synchronized 代码块</strong><br><strong>4. 实例锁 和 全局锁</strong></p>
<h2 id="1-synchronized-原理"><a href="#1-synchronized-原理" class="headerlink" title="1. synchronized 原理"></a><strong><a></a>1. synchronized 原理</strong></h2><p><strong>在 java 中，每一个对象有且仅有一个同步锁。这也意味着，同步锁是依赖于对象而存在。</strong><br><strong>当我们调用某对象的 synchronized 方法时，就获取了该对象的同步锁。</strong>例如，synchronized(obj)就获取了 “obj 这个对象” 的同步锁。<br><strong>不同线程对同步锁的访问是互斥的。</strong>也就是说，某时间点，对象的同步锁只能被一个线程获取到！通过同步锁，我们就能在多线程中，实现对 “对象 / 方法” 的互斥访问。 例如，现在有两个线程 A 和线程 B，它们都会访问 “对象 obj 的同步锁”。假设，在某一时刻，线程 A 获取到“obj 的同步锁” 并在执行一些操作；而此时，线程 B 也企图获取 “obj 的同步锁” —— 线程 B 会获取失败，它必须等待，直到线程 A 释放了“该对象的同步锁” 之后线程 B 才能获取到 “obj 的同步锁” 从而才可以运行。</p>
<h2 id="2-synchronized-基本规则"><a href="#2-synchronized-基本规则" class="headerlink" title="2. synchronized 基本规则"></a><strong><a></a>2. synchronized 基本规则</strong></h2><p>我们将 synchronized 的基本规则总结为下面 3 条，并通过实例对它们进行说明。</p>
<p><strong>第一条</strong>: 当一个线程访问 “某对象” 的“synchronized 方法”或者 “synchronized 代码块” 时，其他线程对 <strong>“该对象”的该 “synchronized 方法” 或者 “synchronized 代码块” 的访问</strong>将被阻塞。</p>
<p><strong>第二条</strong>: 当一个线程访问 “某对象” 的“synchronized 方法”或者 “synchronized 代码块” 时，其他线程仍然<strong>可以访问 “该对象” 的非同步代码块</strong>。</p>
<p><strong>第三条</strong>: 当一个线程访问 “某对象” 的“synchronized 方法”或者 “synchronized 代码块” 时，其他线程对 <strong>“该对象”的其他的 “synchronized 方法” 或者 “synchronized 代码块” 的访问</strong>将被阻塞。</p>
<h3 id="第一条"><a href="#第一条" class="headerlink" title="第一条"></a><strong><a></a>第一条</strong></h3><p>当一个线程访问 “某对象” 的“synchronized 方法”或者 “synchronized 代码块” 时，其他线程对 “该对象” 的该 “synchronized 方法” 或者 “synchronized 代码块” 的访问将被阻塞。<br>下面是 “synchronized 代码块” 对应的演示程序。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">MyRunable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123; <span class="comment">//注意这里是implements实现</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">" loop "</span> + i);  </span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line">        Runnable demo = <span class="keyword">new</span> MyRunable();     <span class="comment">// 新建“Runnable对象”</span></span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(demo, <span class="string">"t1"</span>);  <span class="comment">// 新建“线程t1”, t1是基于demo这个Runnable对象</span></span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(demo, <span class="string">"t2"</span>);  <span class="comment">// 新建“线程t2”, t2是基于demo这个Runnable对象</span></span><br><span class="line">        t1.start();                          <span class="comment">// 启动“线程t1”</span></span><br><span class="line">        t2.start();                          <span class="comment">// 启动“线程t2” </span></span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">t1 loop 0</span><br><span class="line">t1 loop 1</span><br><span class="line">t1 loop 2</span><br><span class="line">t1 loop 3</span><br><span class="line">t1 loop 4</span><br><span class="line">t2 loop 0</span><br><span class="line">t2 loop 1</span><br><span class="line">t2 loop 2</span><br><span class="line">t2 loop 3</span><br><span class="line">t2 loop 4</span><br></pre></td></tr></table></figure>
<p><strong>结果说明</strong>：<br>run()方法中存在 “synchronized(this) 代码块”，而且 t1 和 t2 都是基于 “demo 这个 Runnable 对象” 创建的线程。这就意味着，我们可以将 synchronized(this)中的 this 看作是 “demo 这个 Runnable 对象”；因此，线程 t1 和 t2 共享“demo 对象的同步锁”。所以，当一个线程运行的时候，另外一个线程必须等待“运行线程” 释放 “demo 的同步锁” 之后才能运行。</p>
<p>如果你确认，你搞清楚这个问题了。那我们将上面的代码进行修改，然后再运行看看结果怎么样，看看你是否会迷糊。修改后的源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123; <span class="comment">//注意这里是extends继承</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">" loop "</span> + i);  </span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line">        Thread t1 = <span class="keyword">new</span> MyThread(<span class="string">"t1"</span>);  <span class="comment">// 新建“线程t1”</span></span><br><span class="line">        Thread t2 = <span class="keyword">new</span> MyThread(<span class="string">"t2"</span>);  <span class="comment">// 新建“线程t2”</span></span><br><span class="line">        t1.start();                          <span class="comment">// 启动“线程t1”</span></span><br><span class="line">        t2.start();                          <span class="comment">// 启动“线程t2” </span></span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>代码说明</strong>：<br>比较 Demo1_2 和 Demo1_1，我们发现，Demo1_2 中的 MyThread 类是直接继承于 Thread，而且 t1 和 t2 都是 MyThread 子线程。<br>幸运的是，在 “Demo1_2 的 run() 方法”也调用了 synchronized(this)，正如 “Demo1_1 的 run() 方法”也调用了 synchronized(this)一样！<br>那么，Demo1_2 的执行流程是不是和 Demo1_1 一样呢？<br>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">t1 loop 0</span><br><span class="line">t2 loop 0</span><br><span class="line">t1 loop 1</span><br><span class="line">t2 loop 1</span><br><span class="line">t1 loop 2</span><br><span class="line">t2 loop 2</span><br><span class="line">t1 loop 3</span><br><span class="line">t2 loop 3</span><br><span class="line">t1 loop 4</span><br><span class="line">t2 loop 4</span><br></pre></td></tr></table></figure>
<p><strong>结果说明</strong>：<br>如果这个结果一点也不令你感到惊讶，那么我相信你对 synchronized 和 this 的认识已经比较深刻了。否则的话，请继续阅读这里的分析。<br>synchronized(this)中的 this 是指 “<strong>当前的类对象</strong>”，即 synchronized(this) 所在的类对应的当前对象。它的作用是获取“当前对象的同步锁”。<br>对于 Demo1_2 中，synchronized(this) 中的 this 代表的是 MyThread 对象，而 <strong>t1 和 t2 是两个不同的 MyThread 对象</strong>，因此 t1 和 t2 在执行 synchronized(this) 时，获取的是不同对象的同步锁。对于 Demo1_1 对而言，synchronized(this) 中的 this 代表的是 MyRunable 对象；t1 和 t2 共同一个 MyRunable 对象，因此，一个线程获取了对象的同步锁，会造成另外一个线程等待。</p>
<h3 id="第二条"><a href="#第二条" class="headerlink" title="第二条"></a><a></a>第二条</h3><p>当一个线程访问 “某对象” 的“synchronized 方法”或者 “synchronized 代码块” 时，其他线程仍然可以访问 “该对象” 的非同步代码块。<br>下面是 “synchronized 代码块” 对应的演示程序。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Count</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 含有synchronized同步块的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">synMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">" synMethod loop "</span> + i);  </span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 非同步的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nonSynMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" nonSynMethod loop "</span> + i);  </span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">final</span> Count count = <span class="keyword">new</span> Count();</span><br><span class="line">        <span class="comment">// 新建t1, t1会调用“count对象”的synMethod()方法</span></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(</span><br><span class="line">                <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        count.synMethod();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="string">"t1"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 新建t2, t2会调用“count对象”的nonSynMethod()方法</span></span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(</span><br><span class="line">                <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        count.nonSynMethod();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="string">"t2"</span>);  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        t1.start();  <span class="comment">// 启动t1</span></span><br><span class="line">        t2.start();  <span class="comment">// 启动t2</span></span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">t1 synMethod loop 0</span><br><span class="line">t2 nonSynMethod loop 0</span><br><span class="line">t1 synMethod loop 1</span><br><span class="line">t2 nonSynMethod loop 1</span><br><span class="line">t1 synMethod loop 2</span><br><span class="line">t2 nonSynMethod loop 2</span><br><span class="line">t1 synMethod loop 3</span><br><span class="line">t2 nonSynMethod loop 3</span><br><span class="line">t1 synMethod loop 4</span><br><span class="line">t2 nonSynMethod loop 4</span><br></pre></td></tr></table></figure>
<p><strong>结果说明</strong>：<br>主线程中新建了两个子线程 t1 和 t2。t1 会调用 count 对象的 synMethod()方法，该方法内含有同步块；而 t2 则会调用 count 对象的 nonSynMethod()方法，该方法不是同步方法。t1 运行时，虽然调用 synchronized(this)获取 “count 的同步锁”；但是并没有造成 t2 的阻塞，因为 t2 没有用到“count” 同步锁。</p>
<h3 id="第三条"><a href="#第三条" class="headerlink" title="第三条"></a><a></a>第三条</h3><p>当一个线程访问 “某对象” 的“synchronized 方法”或者 “synchronized 代码块” 时，其他线程对 “该对象” 的其他的 “synchronized 方法” 或者 “synchronized 代码块” 的访问将被阻塞。<br>我们将上面的例子中的 nonSynMethod() 方法体的也用 synchronized(this) 修饰。修改后的源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Count</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 含有synchronized同步块的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">synMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">" synMethod loop "</span> + i);  </span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 也包含synchronized同步块的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nonSynMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">" nonSynMethod loop "</span> + i);  </span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">final</span> Count count = <span class="keyword">new</span> Count();</span><br><span class="line">        <span class="comment">// 新建t1, t1会调用“count对象”的synMethod()方法</span></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(</span><br><span class="line">                <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        count.synMethod();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="string">"t1"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 新建t2, t2会调用“count对象”的nonSynMethod()方法</span></span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(</span><br><span class="line">                <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        count.nonSynMethod();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="string">"t2"</span>);  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        t1.start();  <span class="comment">// 启动t1</span></span><br><span class="line">        t2.start();  <span class="comment">// 启动t2</span></span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">t1 synMethod loop 0</span><br><span class="line">t1 synMethod loop 1</span><br><span class="line">t1 synMethod loop 2</span><br><span class="line">t1 synMethod loop 3</span><br><span class="line">t1 synMethod loop 4</span><br><span class="line">t2 nonSynMethod loop 0</span><br><span class="line">t2 nonSynMethod loop 1</span><br><span class="line">t2 nonSynMethod loop 2</span><br><span class="line">t2 nonSynMethod loop 3</span><br><span class="line">t2 nonSynMethod loop 4</span><br></pre></td></tr></table></figure>
<p><strong>结果说明</strong>：<br>主线程中新建了两个子线程 t1 和 t2。t1 和 t2 运行时都调用 synchronized(this)，<strong>这个 this 是 Count 对象 (count)</strong>，而 t1 和 t2 共用 count。因此，在 t1 运行时，t2 会被阻塞，等待 t1 运行释放 “count 对象的同步锁”，t2 才能运行。</p>
<h2 id="3-synchronized-方法-和-synchronized-代码块"><a href="#3-synchronized-方法-和-synchronized-代码块" class="headerlink" title="3. synchronized 方法 和 synchronized 代码块"></a><a></a>3. synchronized 方法 和 synchronized 代码块</h2><p>“synchronized 方法” 是用 synchronized 修饰方法，而 “synchronized 代码块” 则是用 synchronized 修饰代码块。</p>
<p><strong>synchronized 方法示例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">foo1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"synchronized methoed"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>synchronized 代码块</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">foo2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        System.out.println(<span class="string">"synchronized methoed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>synchronized 代码块中的 this 是指当前对象。<strong>也可以将 this 替换成其他对象，例如将 this 替换成 obj，则 foo2() 在执行 synchronized(obj) 时就获取的是 obj 的同步锁</strong>。</p>
<p>synchronized 代码块可以更精确的控制冲突限制访问区域，有时候表现更高效率。下面通过一个示例来演示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Demo4.java的源码</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo4</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">synMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">1000000</span>; i++)</span><br><span class="line">            ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">synBlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>( <span class="keyword">this</span> ) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">1000000</span>; i++)</span><br><span class="line">                ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Demo4 demo = <span class="keyword">new</span> Demo4();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> start, diff;</span><br><span class="line">        start = System.currentTimeMillis();                <span class="comment">// 获取当前时间(millis)</span></span><br><span class="line">        demo.synMethod();                                <span class="comment">// 调用“synchronized方法”</span></span><br><span class="line">        diff = System.currentTimeMillis() - start;        <span class="comment">// 获取“时间差值”</span></span><br><span class="line">        System.out.println(<span class="string">"synMethod() : "</span>+ diff);</span><br><span class="line">        </span><br><span class="line">        start = System.currentTimeMillis();                <span class="comment">// 获取当前时间(millis)</span></span><br><span class="line">        demo.synBlock();                                <span class="comment">// 调用“synchronized方法块”</span></span><br><span class="line">        diff = System.currentTimeMillis() - start;        <span class="comment">// 获取“时间差值”</span></span><br><span class="line">        System.out.println(<span class="string">"synBlock()  : "</span>+ diff);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>(某一次) 执行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">synMethod() : 11</span><br><span class="line">synBlock() : 3</span><br></pre></td></tr></table></figure>
<h2 id="4-实例锁-和-全局锁"><a href="#4-实例锁-和-全局锁" class="headerlink" title="4. 实例锁 和 全局锁"></a><strong><a></a>4. 实例锁 和 全局锁</strong></h2><p><strong>实例锁</strong> – 锁在某一个实例对象上。如果该类是单例，那么该锁也具有全局锁的概念。<br>实例锁对应的就是 synchronized 关键字。<br><strong>全局锁</strong> – 该锁针对的是类，无论实例多少个对象，那么线程都共享该锁。<br> 全局锁对应的就是 <strong>static synchronized</strong>（或者是锁在该类的 class 或者 classloader 对象上）。</p>
<p>关于 “实例锁” 和“全局锁”有一个很形象的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pulbic <span class="class"><span class="keyword">class</span> <span class="title">Something</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">isSyncA</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">isSyncB</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">cSyncA</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">cSyncB</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假设，Something 有两个实例 x 和 y。分析下面 4 组表达式获取的锁的情况。<br>(01) <a href="#a41">x.isSyncA() 与 x.isSyncB()</a><br>(02) <a href="#a42">x.isSyncA() 与 y.isSyncA()</a><br>(03) <a href="#a43">x.cSyncA() 与 y.cSyncB()</a><br>(04) <a href="#a44">x.isSyncA() 与 Something.cSyncA()</a></p>
<p><strong><a></a>(01) 不能被同时访问。</strong>因为 isSyncA()和 isSyncB()都是访问同一个对象 (对象 x) 的同步锁！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LockTest1.java的源码</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Something</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">isSyncA</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" : isSyncA"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">isSyncB</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" : isSyncB"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockTest1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Something x = <span class="keyword">new</span> Something();</span><br><span class="line">    Something y = <span class="keyword">new</span> Something();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 比较(01) x.isSyncA()与x.isSyncB() </span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 新建t11, t11会调用 x.isSyncA()</span></span><br><span class="line">        Thread t11 = <span class="keyword">new</span> Thread(</span><br><span class="line">                <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        x.isSyncA();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="string">"t11"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 新建t12, t12会调用 x.isSyncB()</span></span><br><span class="line">        Thread t12 = <span class="keyword">new</span> Thread(</span><br><span class="line">                <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        x.isSyncB();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="string">"t12"</span>);  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        t11.start();  <span class="comment">// 启动t11</span></span><br><span class="line">        t12.start();  <span class="comment">// 启动t12</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        LockTest1 demo = <span class="keyword">new</span> LockTest1();</span><br><span class="line">        demo.test1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">t11 : isSyncA</span><br><span class="line">t11 : isSyncA</span><br><span class="line">t11 : isSyncA</span><br><span class="line">t11 : isSyncA</span><br><span class="line">t11 : isSyncA</span><br><span class="line">t12 : isSyncB</span><br><span class="line">t12 : isSyncB</span><br><span class="line">t12 : isSyncB</span><br><span class="line">t12 : isSyncB</span><br><span class="line">t12 : isSyncB</span><br></pre></td></tr></table></figure>
<p><strong><a></a>(02) 可以同时被访问。</strong>因为访问的不是同一个对象的同步锁，x.isSyncA() 访问的是 x 的同步锁，而 y.isSyncA() 访问的是 y 的同步锁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// LockTest2.java的源码</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Something</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">isSyncA</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" : isSyncA"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">isSyncB</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" : isSyncB"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">cSyncA</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" : cSyncA"</span>);</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">cSyncB</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" : cSyncB"</span>);</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockTest2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Something x = <span class="keyword">new</span> Something();</span><br><span class="line">    Something y = <span class="keyword">new</span> Something();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 比较(02) x.isSyncA()与y.isSyncA()</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 新建t21, t21会调用 x.isSyncA()</span></span><br><span class="line">        Thread t21 = <span class="keyword">new</span> Thread(</span><br><span class="line">                <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        x.isSyncA();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="string">"t21"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 新建t22, t22会调用 x.isSyncB()</span></span><br><span class="line">        Thread t22 = <span class="keyword">new</span> Thread(</span><br><span class="line">                <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        y.isSyncA();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="string">"t22"</span>);  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        t21.start();  <span class="comment">// 启动t21</span></span><br><span class="line">        t22.start();  <span class="comment">// 启动t22</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        LockTest2 demo = <span class="keyword">new</span> LockTest2();</span><br><span class="line"></span><br><span class="line">        demo.test2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">t21 : isSyncA</span><br><span class="line">t22 : isSyncA</span><br><span class="line">t21 : isSyncA</span><br><span class="line">t22 : isSyncA</span><br><span class="line">t21 : isSyncA</span><br><span class="line">t22 : isSyncA</span><br><span class="line">t21 : isSyncA</span><br><span class="line">t22 : isSyncA</span><br><span class="line">t21 : isSyncA</span><br><span class="line">t22 : isSyncA</span><br></pre></td></tr></table></figure>
<p><strong><a></a>(03) 不能被同时访问。</strong>因为 cSyncA() 和 cSyncB() 都是 <strong>static 类型</strong>，x.cSyncA() 相当于 <strong>Something.isSyncA()</strong>，y.cSyncB() 相当于 <strong>Something.isSyncB()</strong>，因此它们共用一个同步锁，不能被同时访问。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LockTest3.java的源码</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Something</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">isSyncA</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" : isSyncA"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">isSyncB</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" : isSyncB"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">cSyncA</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" : cSyncA"</span>);</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">cSyncB</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" : cSyncB"</span>);</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockTest3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Something x = <span class="keyword">new</span> Something();</span><br><span class="line">    Something y = <span class="keyword">new</span> Something();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 比较(03) x.cSyncA()与y.cSyncB()</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 新建t31, t31会调用 x.isSyncA()</span></span><br><span class="line">        Thread t31 = <span class="keyword">new</span> Thread(</span><br><span class="line">                <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        x.cSyncA();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="string">"t31"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 新建t32, t32会调用 x.isSyncB()</span></span><br><span class="line">        Thread t32 = <span class="keyword">new</span> Thread(</span><br><span class="line">                <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        y.cSyncB();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="string">"t32"</span>);  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        t31.start();  <span class="comment">// 启动t31</span></span><br><span class="line">        t32.start();  <span class="comment">// 启动t32</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        LockTest3 demo = <span class="keyword">new</span> LockTest3();</span><br><span class="line"></span><br><span class="line">        demo.test3();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">t31 : cSyncA</span><br><span class="line">t31 : cSyncA</span><br><span class="line">t31 : cSyncA</span><br><span class="line">t31 : cSyncA</span><br><span class="line">t31 : cSyncA</span><br><span class="line">t32 : cSyncB</span><br><span class="line">t32 : cSyncB</span><br><span class="line">t32 : cSyncB</span><br><span class="line">t32 : cSyncB</span><br><span class="line">t32 : cSyncB</span><br></pre></td></tr></table></figure>
<p><strong><a></a>(04) 可以被同时访问。</strong>因为 isSyncA() 是实例方法，x.isSyncA() 使用的是对象 x 的锁；而 cSyncA() 是静态方法，Something.cSyncA() 可以理解对使用的是 “类的锁”。因此，它们是可以被同时访问的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LockTest4.java的源码</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Something</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">isSyncA</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" : isSyncA"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">isSyncB</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" : isSyncB"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">cSyncA</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" : cSyncA"</span>);</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">cSyncB</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" : cSyncB"</span>);</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockTest4</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Something x = <span class="keyword">new</span> Something();</span><br><span class="line">    Something y = <span class="keyword">new</span> Something();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 比较(04) x.isSyncA()与Something.cSyncA()</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 新建t41, t41会调用 x.isSyncA()</span></span><br><span class="line">        Thread t41 = <span class="keyword">new</span> Thread(</span><br><span class="line">                <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        x.isSyncA();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="string">"t41"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 新建t42, t42会调用 x.isSyncB()</span></span><br><span class="line">        Thread t42 = <span class="keyword">new</span> Thread(</span><br><span class="line">                <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        Something.cSyncA();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="string">"t42"</span>);  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        t41.start();  <span class="comment">// 启动t41</span></span><br><span class="line">        t42.start();  <span class="comment">// 启动t42</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        LockTest4 demo = <span class="keyword">new</span> LockTest4();</span><br><span class="line"></span><br><span class="line">        demo.test4();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">t41 : isSyncA</span><br><span class="line">t42 : cSyncA</span><br><span class="line">t41 : isSyncA</span><br><span class="line">t42 : cSyncA</span><br><span class="line">t41 : isSyncA</span><br><span class="line">t42 : cSyncA</span><br><span class="line">t41 : isSyncA</span><br><span class="line">t42 : cSyncA</span><br><span class="line">t41 : isSyncA</span><br><span class="line">t42 : cSyncA</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="05-线程等待与唤醒"><a href="#05-线程等待与唤醒" class="headerlink" title="05 线程等待与唤醒"></a>05 线程等待与唤醒</h1><h2 id="概要-3"><a href="#概要-3" class="headerlink" title="概要"></a>概要</h2><p>本章，会对线程等待 / 唤醒方法进行介绍。涉及到的内容包括：<br>1. wait(), notify(), notifyAll() 等方法介绍<br>2. wait() 和 notify()<br>3. wait(long timeout) 和 notify()<br>4. wait() 和 notifyAll()<br>5. 为什么 notify(), wait() 等函数定义在 Object 中，而不是 Thread 中</p>
<h2 id="1-wait-notify-notifyAll-等方法介绍"><a href="#1-wait-notify-notifyAll-等方法介绍" class="headerlink" title="1.wait(), notify(), notifyAll() 等方法介绍"></a>1.<strong><a></a>wait(), notify(), notifyAll() 等方法介绍</strong></h2><p>在 Object.java 中，定义了 wait(), notify() 和 notifyAll() 等接口。wait() 的作用是让当前线程进入等待状态，同时，<strong>wait() 也会让当前线程释放它所持有的锁</strong>。而 notify() 和 notifyAll() 的作用，则是<strong>唤醒当前对象上的等待线程</strong>；notify() 是唤醒单个线程，而 notifyAll() 是唤醒所有的线程。</p>
<p>Object 类中关于等待 / 唤醒的 API 详细信息如下：<br><strong>notify()        </strong>– 唤醒在此对象监视器上等待的单个线程。<br><strong>notifyAll() </strong>  – 唤醒在此对象监视器上等待的所有线程。<br><strong>wait()          </strong>                               – 让当前线程处于 “等待(阻塞) 状态”，“直到其他线程调用此对象的 notify() 方法或 notifyAll() 方法”，当前线程被唤醒(进入“就绪状态”)。<br><strong>wait(long timeout)    </strong>                – 让当前线程处于 “等待(阻塞) 状态”，“直到其他线程调用此对象的 notify() 方法或 notifyAll() 方法，或者超过指定的时间量”，当前线程被唤醒(进入“就绪状态”)。<br><strong>wait(long timeout, int nanos)  </strong>– 让当前线程处于 “等待(阻塞) 状态”，“直到其他线程调用此对象的 notify() 方法或 notifyAll() 方法，或者其他某个线程中断当前线程，或者已超过某个实际时间量”，当前线程被唤醒(进入“就绪状态”)。</p>
<h2 id="2-wait-和-notify-示例"><a href="#2-wait-和-notify-示例" class="headerlink" title="2. wait() 和 notify() 示例"></a><strong><a></a>2. wait() 和 notify() 示例</strong></h2><p>下面通过示例演示 “wait() 和 notify() 配合使用的情形”。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WaitTest.java的源码</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadA</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreadA</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">" call notify()"</span>);</span><br><span class="line">            <span class="comment">// 唤醒当前的wait线程</span></span><br><span class="line">            notify();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaitTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ThreadA t1 = <span class="keyword">new</span> ThreadA(<span class="string">"t1"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(t1) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 启动“线程t1”</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" start t1"</span>);</span><br><span class="line">                t1.start();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 主线程等待t1通过notify()唤醒。</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" wait()"</span>);</span><br><span class="line">                <span class="comment">//虽然 t1.wait()是通过 “线程 t1” 调用的 wait()方法，但是调用 t1.wait()的地方是在 “主线程 main” 中,t1.wait()是让 “主线程” 等待，而不是“线程 t1”！</span></span><br><span class="line">                t1.wait();</span><br><span class="line"></span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" continue"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">main start t1</span><br><span class="line">main wait()</span><br><span class="line">t1 call notify()</span><br><span class="line">main continue</span><br></pre></td></tr></table></figure>
<p><strong>结果说明</strong>：<br>如下图，说明了 “主线程” 和“线程 t1”的流程。</p>
<p>(01) 注意，图中 “主线程” 代表 “主线程 main”。”线程 t1” 代表 WaitTest 中启动的 “线程 t1”。 而 “锁” 代表 “t1 这个对象的同步锁”。<br>(02) “主线程”通过 new ThreadA(“t1”) 新建 “线程 t1”。随后通过 synchronized(t1) 获取 “t1 对象的同步锁”。然后调用 t1.start() 启动“线程 t1”。<br>(03) “主线程”执行 <strong>t1.wait()是让 “主线程” 等待，而不是“线程 t1”！</strong> ,释放 “t1 对象的锁” 并且进入 “等待(阻塞) 状态”。等待 t1 对象上的线程通过 notify() 或 notifyAll()将其唤醒。<br>(04) “线程 t1”运行之后，通过 synchronized(this)获取 “当前对象的锁”；接着调用 notify() 唤醒“当前对象上的等待线程”，也就是唤醒“主线程”。<br>(05) “线程 t1”运行完毕之后，释放 “当前对象的锁”。紧接着，“主线程” 获取“t1 对象的锁”，然后接着运行。</p>
<p><img src="http://p4lmrb1gp.bkt.clouddn.com/15219001605934.png" alt=""></p>
<p>对于上面的代码？曾经有个朋友问到过：t1.wait()应该是让 “线程 t1” 等待；但是，为什么却是让 “主线程 main” 等待了呢？<br>在解答该问题前，我们先看看 jdk 文档中关于 wait 的一段介绍：</p>
<blockquote>
<p>Causes the current thread to wait until another thread invokes the notify() method or the notifyAll() method for this object.<br>In other words, this method behaves exactly as if it simply performs the call wait(0).<br>The current thread must own this object’s monitor. The thread releases ownership of this monitor and waits until another thread notifies threads waiting on this object’s monitor to wake up either through a call to the notify method or the notifyAll method. The thread then waits until it can re-obtain ownership of the monitor and resumes execution.</p>
</blockquote>
<p>中文意思大概是：</p>
<p>引起“当前线程”等待，直到另外一个线程调用notify()或notifyAll()唤醒该线程。换句话说，这个方法和wait(0)的效果一样！(补充，对于wait(long millis)方法，当millis为0时，表示无限等待，直到被notify()或notifyAll()唤醒)。<br>“当前线程”在调用wait()时，必须拥有该对象的同步锁。该线程调用wait()之后，会释放该锁；然后一直等待直到“其它线程”调用对象的同步锁的notify()或notifyAll()方法。然后，该线程继续等待直到它重新获取“该对象的同步锁”，然后就可以接着运行。</p>
<p>注意：jdk 的解释中，说 <strong>wait()的作用是让 “当前线程” 等待，而 “当前线程” 是指正在 cpu 上运行的线程！</strong><br><strong>这也意味着，虽然 t1.wait()是通过 “线程 t1” 调用的 wait()方法，但是调用 t1.wait()的地方是在 “主线程 main” 中。而主线程必须是 “当前线程”，也就是运行状态，才可以执行 t1.wait()。所以，此时的“当前线程” 是“主线程 main”！因此，t1.wait()是让 “主线程” 等待，而不是“线程 t1”！</strong></p>
<h2 id="3-wait-long-timeout-和-notify"><a href="#3-wait-long-timeout-和-notify" class="headerlink" title="3. wait(long timeout) 和 notify()"></a><strong><a></a>3. wait(long timeout) 和 notify()</strong></h2><p>wait(long timeout)会让当前线程处于 “等待(阻塞) 状态”，“直到其他线程调用此对象的 notify() 方法或 notifyAll() 方法，或者超过指定的时间量”，当前线程被唤醒(进入“就绪状态”)。<br>下面的示例就是演示 wait(long timeout) 在超时情况下，线程被唤醒的情况。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WaitTimeoutTest.java的源码</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadA</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreadA</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" run "</span>);</span><br><span class="line">        <span class="comment">// 死循环，不断运行。</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)</span><br><span class="line">            ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaitTimeoutTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ThreadA t1 = <span class="keyword">new</span> ThreadA(<span class="string">"t1"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(t1) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 启动“线程t1”</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" start t1"</span>);</span><br><span class="line">                t1.start();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 主线程等待t1通过notify()唤醒 或 notifyAll()唤醒，或超过3000ms延时；然后才被唤醒。</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" call wait "</span>);</span><br><span class="line">                t1.wait(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" continue"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">main start t1</span><br><span class="line">main call wait </span><br><span class="line">t1 run                  // 大约3秒之后...输出“main continue”</span><br><span class="line">main continue</span><br></pre></td></tr></table></figure>
<p><strong>结果说明</strong>：<br>如下图，说明了 “主线程” 和“线程 t1”的流程。<br>(01) 注意，图中 “主线程” 代表 WaitTimeoutTest 主线程 (即，线程 main)。”线程 t1” 代表 WaitTest 中启动的线程 t1。 而 “锁” 代表 “t1 这个对象的同步锁”。<br>(02) 主线程 main 执行 t1.start() 启动 “线程 t1”。<br>(03) 主线程 main 执行 t1.wait(3000)，此时，主线程进入 “阻塞状态”。需要“用于 t1 对象锁的线程通过 notify() 或者 notifyAll() 将其唤醒” 或者 “超时 3000ms 之后”，主线程 main 才进入到“就绪状态”，然后才可以运行。<br>(04) “线程 t1” 运行之后，进入了死循环，一直不断的运行。<br>(05) 超时 3000ms 之后，主线程 main 会进入到 “就绪状态”，然后接着进入 “运行状态”。</p>
<p><img src="http://p4lmrb1gp.bkt.clouddn.com/15219001769486.png" alt=""></p>
<h2 id="4-wait-和-notifyAll"><a href="#4-wait-和-notifyAll" class="headerlink" title="4. wait() 和 notifyAll()"></a><strong><a></a>4. wait() 和 notifyAll()</strong></h2><p>通过前面的示例，我们知道 notify() 可以唤醒在此对象监视器上等待的单个线程。<br>下面，我们通过示例演示 notifyAll() 的用法；它的作用是唤醒在此对象监视器上等待的所有线程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotifyAllTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object obj = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ThreadA t1 = <span class="keyword">new</span> ThreadA(<span class="string">"t1"</span>);</span><br><span class="line">        ThreadA t2 = <span class="keyword">new</span> ThreadA(<span class="string">"t2"</span>);</span><br><span class="line">        ThreadA t3 = <span class="keyword">new</span> ThreadA(<span class="string">"t3"</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t3.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">" sleep(3000)"</span>);</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(obj) &#123;</span><br><span class="line">            <span class="comment">// 主线程等待唤醒。</span></span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">" notifyAll()"</span>);</span><br><span class="line">            obj.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadA</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ThreadA</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 打印输出结果</span></span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">" wait"</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 唤醒当前的wait线程</span></span><br><span class="line">                    obj.wait();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 打印输出结果</span></span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">" continue"</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">t1 wait</span><br><span class="line">main sleep(3000)</span><br><span class="line">t3 wait</span><br><span class="line">t2 wait</span><br><span class="line">main notifyAll()</span><br><span class="line">t2 continue</span><br><span class="line">t3 continue</span><br><span class="line">t1 continue</span><br></pre></td></tr></table></figure>
<p><strong>结果说明</strong>：<br>参考下面的流程图。<br>(01) 主线程中新建并且启动了 3 个线程 “t1”, “t2” 和 “t3”。<br>(02) 主线程通过 sleep(3000) 休眠 3 秒。在主线程休眠 3 秒的过程中，我们假设 “t1”, “t2” 和 “t3” 这 3 个线程都运行了。以 “t1” 为例，当它运行的时候，它会执行 obj.wait() 等待其它线程通过 notify() 或额 nofityAll() 来唤醒它；相同的道理，”t2” 和 “t3” 也会等待其它线程通过 nofity() 或 nofityAll() 来唤醒它们。<br>(03) 主线程休眠 3 秒之后，接着运行。执行 obj.notifyAll() 唤醒 obj 上的等待线程，即唤醒 “t1”, “t2” 和 “t3” 这 3 个线程。 紧接着，主线程的 synchronized(obj)运行完毕之后，主线程释放 “obj 锁”。这样，”t1”, “t2” 和 “t3” 就可以获取“obj 锁” 而继续运行了！</p>
<p><img src="http://p4lmrb1gp.bkt.clouddn.com/15219002092499.png" alt=""></p>
<h2 id="5-为什么-notify-wait-等函数定义在-Object-中，而不是-Thread-中"><a href="#5-为什么-notify-wait-等函数定义在-Object-中，而不是-Thread-中" class="headerlink" title="5. 为什么 notify(), wait() 等函数定义在 Object 中，而不是 Thread 中"></a><strong><a></a>5. 为什么 notify(), wait() 等函数定义在 Object 中，而不是 Thread 中</strong></h2><p>Object 中的 wait(), notify()等函数，和 synchronized 一样，会对 “对象的同步锁” 进行操作。</p>
<p>wait()会使 “当前线程” 等待，因为线程进入等待状态，所以线程应该释放它锁持有的 “同步锁”，否则其它线程获取不到该“同步锁” 而无法运行！<br>OK，<strong>线程调用 wait()之后，会释放它锁持有的 “同步锁”</strong>；而且，根据前面的介绍，我们知道：等待线程可以被 notify() 或 notifyAll()唤醒。现在，请思考一个问题：notify() 是依据什么唤醒等待线程的？或者说，wait() 等待线程和 notify() 之间是通过什么关联起来的？答案是：<strong>依据 “对象的同步锁”</strong>。</p>
<p>负责唤醒等待线程的那个线程 (我们称为 “<strong>唤醒线程</strong>”)，它只有在获取 “该对象的同步锁”(<strong>这里的同步锁必须和等待线程的同步锁是同一个</strong>)，并且调用 notify()或 notifyAll()方法之后，才能唤醒等待线程。虽然，等待线程被唤醒；但是，它不能立刻执行，因为唤醒线程还持有 “该对象的同步锁”。<strong>必须等到唤醒线程释放了“对象的同步锁” 之后，等待线程才能获取到 “对象的同步锁” 进而继续运行。</strong></p>
<p>总之，<strong>notify(), wait()依赖于 “同步锁”</strong>，而“同步锁” 是<strong>对象锁</strong>持有，并且每个对象有且仅有一个！这就是为什么 notify(), wait()等函数定义在 Object 类，而不是 Thread 类中的原因。</p>
<hr>
<h1 id="06-线程让步"><a href="#06-线程让步" class="headerlink" title="06 线程让步"></a>06 线程让步</h1><h2 id="概要-4"><a href="#概要-4" class="headerlink" title="概要"></a><strong>概要</strong></h2><p>本章，会对 Thread 中的线程让步方法 yield() 进行介绍。涉及到的内容包括：<br><a href="#p1">1. yield() 介绍</a><br><a href="#p2">2. yield() 示例</a><br><a href="#p3">3. yield() 与 wait() 的比较</a></p>
<h2 id="1-yield-介绍"><a href="#1-yield-介绍" class="headerlink" title="1. yield() 介绍"></a><strong><a></a>1. yield() 介绍</strong></h2><p>yield()的作用是<strong>让步</strong>。它能让当前线程由 “运行状态” 进入到 “就绪状态”，从而让其它具有相同优先级的等待线程获取执行权；但是，并不能保证在当前线程调用 yield() 之后，其它具有相同优先级的线程就一定能获得执行权；也有可能是当前线程又进入到 “运行状态” 继续运行！</p>
<h2 id="2-yield-示例"><a href="#2-yield-示例" class="headerlink" title="2. yield() 示例"></a><strong><a></a>2. yield() 示例</strong></h2><p>下面，通过示例查看它的用法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YieldTest.java的源码</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadA</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreadA</span><span class="params">(String name)</span></span>&#123; </span><br><span class="line">        <span class="keyword">super</span>(name); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123; </span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i &lt;<span class="number">10</span>; i++)&#123; </span><br><span class="line">            System.out.printf(<span class="string">"%s [%d]:%d\n"</span>, <span class="keyword">this</span>.getName(), <span class="keyword">this</span>.getPriority(), i); </span><br><span class="line">            <span class="comment">// i整除4时，调用yield</span></span><br><span class="line">            <span class="keyword">if</span> (i%<span class="number">4</span> == <span class="number">0</span>)</span><br><span class="line">                Thread.yield();</span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YieldTest</span></span>&#123; </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123; </span><br><span class="line">        ThreadA t1 = <span class="keyword">new</span> ThreadA(<span class="string">"t1"</span>); </span><br><span class="line">        ThreadA t2 = <span class="keyword">new</span> ThreadA(<span class="string">"t2"</span>); </span><br><span class="line">        t1.start(); </span><br><span class="line">        t2.start();</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>(某一次的) 运行结果</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">t1 [5]:0</span><br><span class="line">t2 [5]:0</span><br><span class="line">t1 [5]:1</span><br><span class="line">t1 [5]:2</span><br><span class="line">t1 [5]:3</span><br><span class="line">t1 [5]:4</span><br><span class="line">t1 [5]:5</span><br><span class="line">t1 [5]:6</span><br><span class="line">t1 [5]:7</span><br><span class="line">t1 [5]:8</span><br><span class="line">t1 [5]:9</span><br><span class="line">t2 [5]:1</span><br><span class="line">t2 [5]:2</span><br><span class="line">t2 [5]:3</span><br><span class="line">t2 [5]:4</span><br><span class="line">t2 [5]:5</span><br><span class="line">t2 [5]:6</span><br><span class="line">t2 [5]:7</span><br><span class="line">t2 [5]:8</span><br><span class="line">t2 [5]:9</span><br></pre></td></tr></table></figure>
<p><strong>结果说明</strong>：<br>“线程 t1”在能被 4 整数的时候，并没有切换到 “线程 t2”。这表明，yield() 虽然可以让线程由 “运行状态” 进入到 “就绪状态”；但是，它不一定会让其它线程获取 CPU 执行权(即，其它线程进入到“运行状态”)，即使这个“其它线程” 与当前调用 yield()的线程具有相同的优先级。</p>
<h2 id="3-yield-与-wait-的比较"><a href="#3-yield-与-wait-的比较" class="headerlink" title="3. yield() 与 wait() 的比较"></a><strong><a></a>3. yield() 与 wait() 的比较</strong></h2><p>我们知道，<a href="http://www.cnblogs.com/skywang12345/p/3479224.html" target="_blank" rel="noopener">wait()</a> 的作用是让当前线程由 “运行状态” 进入 “等待(阻塞) 状态”的同时，也会释放同步锁。而 yield()的作用是让步，它也会让当前线程离开“运行状态”。它们的区别是：<br>(01) wait()是让线程由 “运行状态” 进入到 “等待(阻塞) 状态”，而 yield()是让线程由 “运行状态” 进入到“就绪状态”。<br>(02) wait() 会让线程释放它所持有对象的同步锁，而 yield() 方法不会释放锁。</p>
<p>下面通过示例演示 yield() 是不会释放锁的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// YieldLockTest.java 的源码</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YieldLockTest</span></span>&#123; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object obj = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123; </span><br><span class="line">        ThreadA t1 = <span class="keyword">new</span> ThreadA(<span class="string">"t1"</span>); </span><br><span class="line">        ThreadA t2 = <span class="keyword">new</span> ThreadA(<span class="string">"t2"</span>); </span><br><span class="line">        t1.start(); </span><br><span class="line">        t2.start();</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadA</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ThreadA</span><span class="params">(String name)</span></span>&#123; </span><br><span class="line">            <span class="keyword">super</span>(name); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123; </span><br><span class="line">            <span class="comment">// 获取obj对象的同步锁</span></span><br><span class="line">            <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i &lt;<span class="number">10</span>; i++)&#123; </span><br><span class="line">                    System.out.printf(<span class="string">"%s [%d]:%d\n"</span>, <span class="keyword">this</span>.getName(), <span class="keyword">this</span>.getPriority(), i); </span><br><span class="line">                    <span class="comment">// i整除4时，调用yield</span></span><br><span class="line">                    <span class="keyword">if</span> (i%<span class="number">4</span> == <span class="number">0</span>)</span><br><span class="line">                        Thread.yield();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>(某一次) 运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">t1 [5]:0</span><br><span class="line">t1 [5]:1</span><br><span class="line">t1 [5]:2</span><br><span class="line">t1 [5]:3</span><br><span class="line">t1 [5]:4</span><br><span class="line">t1 [5]:5</span><br><span class="line">t1 [5]:6</span><br><span class="line">t1 [5]:7</span><br><span class="line">t1 [5]:8</span><br><span class="line">t1 [5]:9</span><br><span class="line">t2 [5]:0</span><br><span class="line">t2 [5]:1</span><br><span class="line">t2 [5]:2</span><br><span class="line">t2 [5]:3</span><br><span class="line">t2 [5]:4</span><br><span class="line">t2 [5]:5</span><br><span class="line">t2 [5]:6</span><br><span class="line">t2 [5]:7</span><br><span class="line">t2 [5]:8</span><br><span class="line">t2 [5]:9</span><br></pre></td></tr></table></figure>
<p><strong>结果说明</strong>：<br>主线程 main 中启动了两个线程 t1 和 t2。t1 和 t2 在 run() 会引用同一个对象的同步锁，即 synchronized(obj)。在 t1 运行过程中，虽然它会调用 Thread.yield()；但是，t2 是不会获取 cpu 执行权的。因为，t1 并没有释放 “obj 所持有的同步锁”！</p>
<hr>
<h1 id="07-线程休眠"><a href="#07-线程休眠" class="headerlink" title="07 线程休眠"></a>07 线程休眠</h1><h2 id="概要-5"><a href="#概要-5" class="headerlink" title="概要"></a>概要</h2><p>本章，会对 Thread 中 sleep() 方法进行介绍。涉及到的内容包括：<br><a href="#p1">1. sleep() 介绍</a><br><a href="#p2">2. sleep() 示例</a><br><a href="#p3">3. sleep() 与 wait() 的比较</a></p>
<h2 id="1-sleep-介绍"><a href="#1-sleep-介绍" class="headerlink" title="1. sleep() 介绍"></a><strong><a></a>1. sleep() 介绍</strong></h2><p>sleep() 定义在 Thread.java 中。<br>sleep() 的作用是让当前线程休眠，即当前线程会从 “<a href="http://www.cnblogs.com/skywang12345/p/3479024.html" target="_blank" rel="noopener">运行状态</a>” 进入到 “<a href="http://www.cnblogs.com/skywang12345/p/3479024.html" target="_blank" rel="noopener">休眠 (阻塞) 状态</a>”。sleep() 会指定休眠时间，线程休眠的时间会大于 / 等于该休眠时间；在线程重新被唤醒时，它会由 “<a href="http://www.cnblogs.com/skywang12345/p/3479024.html" target="_blank" rel="noopener">阻塞状态</a>” 变成 “<a href="http://www.cnblogs.com/skywang12345/p/3479024.html" target="_blank" rel="noopener">就绪状态</a>”，从而等待 cpu 的调度执行。</p>
<h2 id="2-sleep-示例"><a href="#2-sleep-示例" class="headerlink" title="2. sleep() 示例"></a><strong><a></a>2. sleep() 示例</strong></h2><p>下面通过一个简单示例演示 sleep() 的用法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SleepTest.java的源码</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadA</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreadA</span><span class="params">(String name)</span></span>&#123; </span><br><span class="line">        <span class="keyword">super</span>(name); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i &lt;<span class="number">10</span>; i++)&#123; </span><br><span class="line">                System.out.printf(<span class="string">"%s: %d\n"</span>, <span class="keyword">this</span>.getName(), i); </span><br><span class="line">                <span class="comment">// i能被4整除时，休眠100毫秒</span></span><br><span class="line">                <span class="keyword">if</span> (i%<span class="number">4</span> == <span class="number">0</span>)</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            &#125; </span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SleepTest</span></span>&#123; </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123; </span><br><span class="line">        ThreadA t1 = <span class="keyword">new</span> ThreadA(<span class="string">"t1"</span>); </span><br><span class="line">        t1.start(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">t1: 0</span><br><span class="line">t1: 1</span><br><span class="line">t1: 2</span><br><span class="line">t1: 3</span><br><span class="line">t1: 4</span><br><span class="line">t1: 5</span><br><span class="line">t1: 6</span><br><span class="line">t1: 7</span><br><span class="line">t1: 8</span><br><span class="line">t1: 9</span><br></pre></td></tr></table></figure>
<p><strong>结果说明</strong>：<br>程序比较简单，在主线程 main 中启动线程 t1。t1 启动之后，当 t1 中的计算 i 能被 4 整除时，t1 会通过 Thread.sleep(100) 休眠 100 毫秒。</p>
<h2 id="3-sleep-与-wait-的比较"><a href="#3-sleep-与-wait-的比较" class="headerlink" title="3. sleep() 与 wait() 的比较"></a><strong><a></a>3. sleep() 与 wait() 的比较</strong></h2><p>我们知道，wait()的作用是让当前线程由 “运行状态” 进入 “等待(阻塞) 状态”的同时，也会释放同步锁。而 sleep()的作用是也是让当前线程由 “运行状态” 进入到 “休眠(阻塞) 状态”。<br>但是，<strong>wait() 会释放对象的同步锁，而 sleep() 则不会释放锁</strong>。<br>下面通过示例演示 sleep() 是不会释放锁的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SleepLockTest.java的源码</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SleepLockTest</span></span>&#123; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object obj = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123; </span><br><span class="line">        ThreadA t1 = <span class="keyword">new</span> ThreadA(<span class="string">"t1"</span>); </span><br><span class="line">        ThreadA t2 = <span class="keyword">new</span> ThreadA(<span class="string">"t2"</span>); </span><br><span class="line">        t1.start(); </span><br><span class="line">        t2.start();</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadA</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ThreadA</span><span class="params">(String name)</span></span>&#123; </span><br><span class="line">            <span class="keyword">super</span>(name); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123; </span><br><span class="line">            <span class="comment">// 获取obj对象的同步锁</span></span><br><span class="line">            <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i &lt;<span class="number">10</span>; i++)&#123; </span><br><span class="line">                        System.out.printf(<span class="string">"%s: %d\n"</span>, <span class="keyword">this</span>.getName(), i); </span><br><span class="line">                        <span class="comment">// i能被4整除时，休眠100毫秒</span></span><br><span class="line">                        <span class="keyword">if</span> (i%<span class="number">4</span> == <span class="number">0</span>)</span><br><span class="line">                            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">t1: 0</span><br><span class="line">t1: 1</span><br><span class="line">t1: 2</span><br><span class="line">t1: 3</span><br><span class="line">t1: 4</span><br><span class="line">t1: 5</span><br><span class="line">t1: 6</span><br><span class="line">t1: 7</span><br><span class="line">t1: 8</span><br><span class="line">t1: 9</span><br><span class="line">t2: 0</span><br><span class="line">t2: 1</span><br><span class="line">t2: 2</span><br><span class="line">t2: 3</span><br><span class="line">t2: 4</span><br><span class="line">t2: 5</span><br><span class="line">t2: 6</span><br><span class="line">t2: 7</span><br><span class="line">t2: 8</span><br><span class="line">t2: 9</span><br></pre></td></tr></table></figure>
<p><strong>结果说明</strong>：<br>主线程 main 中启动了两个线程 t1 和 t2。t1 和 t2 在 run() 会引用同一个对象的同步锁，即 synchronized(obj)。在 t1 运行过程中，虽然它会调用 Thread.sleep(100)；但是，t2 是不会获取 cpu 执行权的。因为，t1 并没有释放 “obj 所持有的同步锁”！<br>注意，若我们注释掉 synchronized (obj) 后再次执行该程序，t1 和 t2 是可以相互切换的。下面是注释调 synchronized(obj) 之后的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SleepLockTest.java的源码(注释掉synchronized(obj))</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SleepLockTest</span></span>&#123; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object obj = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123; </span><br><span class="line">        ThreadA t1 = <span class="keyword">new</span> ThreadA(<span class="string">"t1"</span>); </span><br><span class="line">        ThreadA t2 = <span class="keyword">new</span> ThreadA(<span class="string">"t2"</span>); </span><br><span class="line">        t1.start(); </span><br><span class="line">        t2.start();</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadA</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ThreadA</span><span class="params">(String name)</span></span>&#123; </span><br><span class="line">            <span class="keyword">super</span>(name); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123; </span><br><span class="line">            <span class="comment">// 获取obj对象的同步锁</span></span><br><span class="line"><span class="comment">//            synchronized (obj) &#123;</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i &lt;<span class="number">10</span>; i++)&#123; </span><br><span class="line">                        System.out.printf(<span class="string">"%s: %d\n"</span>, <span class="keyword">this</span>.getName(), i); </span><br><span class="line">                        <span class="comment">// i能被4整除时，休眠100毫秒</span></span><br><span class="line">                        <span class="keyword">if</span> (i%<span class="number">4</span> == <span class="number">0</span>)</span><br><span class="line">                            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="08-join"><a href="#08-join" class="headerlink" title="08 join()"></a>08 join()</h1><h2 id="概要-6"><a href="#概要-6" class="headerlink" title="概要"></a>概要</h2><p>本章，会对 Thread 中 join() 方法进行介绍。涉及到的内容包括：<br><a href="#p1">1. join() 介绍</a><br><a href="#p2">2. join() 源码分析 (基于 JDK1.7.0_40)</a><br><a href="#p3">3. join() 示例</a></p>
<h2 id="1-join-介绍"><a href="#1-join-介绍" class="headerlink" title="1. join() 介绍"></a><a></a>1. join() 介绍</h2><p>join() 定义在 Thread.java 中。<br>join() 的作用：让 “主线程” 等待 “子线程” 结束之后才能继续运行。这句话可能有点晦涩，我们还是通过例子去理解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主线程</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Father</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Son s = <span class="keyword">new</span> Son();</span><br><span class="line">        s.start();</span><br><span class="line">        s.join();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 子线程</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Son</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明</strong>：<br>上面的有两个类 Father(主线程类) 和 Son(子线程类)。因为 Son 是在 Father 中创建并启动的，所以，Father 是主线程类，Son 是子线程类。<br>在 Father 主线程中，通过 new Son()新建 “子线程 s”。接着通过 s.start() 启动 “子线程 s”，并且调用 s.join()。在调用 s.join() 之后，Father 主线程会一直等待，直到 “子线程 s” 运行完毕；在 “子线程 s” 运行完毕之后，Father 主线程才能接着运行。 这也就是我们所说的 “join() 的作用，是让主线程会等待子线程结束之后才能继续运行”！</p>
<h2 id="2-join-源码分析-基于-JDK1-7-0-40"><a href="#2-join-源码分析-基于-JDK1-7-0-40" class="headerlink" title="2. join() 源码分析 (基于 JDK1.7.0_40)"></a><strong><a></a>2. join() 源码分析 (基于 JDK1.7.0_40)</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">join</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    join(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">join</span><span class="params">(<span class="keyword">long</span> millis)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> base = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">long</span> now = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (millis &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"timeout value is negative"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (millis == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (isAlive()) &#123;</span><br><span class="line">            wait(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (isAlive()) &#123;</span><br><span class="line">            <span class="keyword">long</span> delay = millis - now;</span><br><span class="line">            <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            wait(delay);</span><br><span class="line">            now = System.currentTimeMillis() - base;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明</strong>：<br>从代码中，我们可以发现。当 millis==0 时，会进入 while(isAlive()) 循环；即只要子线程是活的，主线程就不停的等待。<br>我们根据上面解释 join() 作用时的代码来理解 join() 的用法！<br><strong>问题</strong>：<br>虽然 s.join()被调用的地方是发生在 “Father 主线程” 中，但是 s.join()是通过 “子线程 s” 去调用的 join()。那么，join()方法中的 isAlive()应该是判断 “子线程 s” 是不是 Alive 状态；对应的 wait(0)也应该是 “让子线程 s” 等待才对。但如果是这样的话，s.join()的作用怎么可能是 “让主线程等待，直到子线程 s 完成为止” 呢，应该是让 “子线程等待才对(因为调用子线程对象 s 的 wait 方法嘛)”？<br><strong>答案</strong>：<a href="http://www.cnblogs.com/skywang12345/p/3479224.html" target="_blank" rel="noopener">wait()</a> 的作用是让 <strong>“当前线程” 等待，而这里的 “当前线程” 是指当前在 CPU 上运行的线程</strong>。所以，虽然是调用子线程的 wait()方法，但是它是通过 “主线程” 去调用的；所以，<strong>休眠的是主线程，而不是“子线程”！</strong></p>
<h2 id="3-join-示例"><a href="#3-join-示例" class="headerlink" title="3. join() 示例"></a><strong><a></a>3. join() 示例</strong></h2><p>在理解 join() 的作用之后，接下来通过示例查看 join() 的用法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JoinTest.java的源码</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinTest</span></span>&#123; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123; </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ThreadA t1 = <span class="keyword">new</span> ThreadA(<span class="string">"t1"</span>); <span class="comment">// 新建“线程t1”</span></span><br><span class="line"></span><br><span class="line">            t1.start();                     <span class="comment">// 启动“线程t1”</span></span><br><span class="line">            t1.join();                        <span class="comment">// 将“线程t1”加入到“主线程main”中，并且“主线程main()会等待它的完成”</span></span><br><span class="line">            System.out.printf(<span class="string">"%s finish\n"</span>, Thread.currentThread().getName()); </span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadA</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ThreadA</span><span class="params">(String name)</span></span>&#123; </span><br><span class="line">            <span class="keyword">super</span>(name); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123; </span><br><span class="line">            System.out.printf(<span class="string">"%s start\n"</span>, <span class="keyword">this</span>.getName()); </span><br><span class="line"></span><br><span class="line">            <span class="comment">// 延时操作</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i &lt;<span class="number">1000000</span>; i++)</span><br><span class="line">               ;</span><br><span class="line"></span><br><span class="line">            System.out.printf(<span class="string">"%s finish\n"</span>, <span class="keyword">this</span>.getName()); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">t1 start</span><br><span class="line">t1 finish</span><br><span class="line">main finish</span><br></pre></td></tr></table></figure>
<p><strong>结果说明</strong>：<br>运行流程如图<br>(01) 在 “主线程 main” 中通过 new ThreadA(“t1”) 新建“线程 t1”。 接着，通过 t1.start() 启动“线程 t1”，并执行 t1.join()。<br>(02) 执行 t1.join()之后，“主线程 main”会进入 “阻塞状态” 等待 t1 运行结束。“子线程 t1”结束之后，会唤醒 “主线程 main”，“主线程” 重新获取 cpu 执行权，继续运行。</p>
<p><img src="http://p4lmrb1gp.bkt.clouddn.com/15219002479692.png" alt=""></p>
<hr>
<h1 id="09-interrupt-和线程终止方式"><a href="#09-interrupt-和线程终止方式" class="headerlink" title="09 interrupt()和线程终止方式"></a>09 interrupt()和线程终止方式</h1><h2 id="概要-7"><a href="#概要-7" class="headerlink" title="概要"></a><strong>概要</strong></h2><p>本章，会对线程的 interrupt() 中断和终止方式进行介绍。涉及到的内容包括：<br><a href="#p1">1. interrupt() 说明</a><br><a href="#p2">2. 终止线程的方式</a> <a href="#a21">  2.1 终止处于 “阻塞状态” 的线程</a> <a href="#p2"></a> <a href="#a22">  2.2 终止处于 “运行状态” 的线程</a><br><a href="#p3">3. 终止线程的示例</a><br><a href="#p4">4. interrupted() 和 isInterrupted() 的区别</a></p>
<h2 id="1-interrupt-说明"><a href="#1-interrupt-说明" class="headerlink" title="1. interrupt() 说明"></a><a></a>1. interrupt() 说明</h2><p>在介绍终止线程的方式之前，有必要先对 interrupt() 进行了解。<br>关于 interrupt()，java 的 djk 文档描述如下：<a href="http://docs.oracle.com/javase/7/docs/api/" target="_blank" rel="noopener">http://docs.oracle.com/javase/7/docs/api/</a></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Interrupts this thread.</span><br><span class="line">Unless the current thread is interrupting itself, which is always permitted, the checkAccess method of this thread is invoked, which may cause a SecurityException to be thrown.</span><br><span class="line"></span><br><span class="line">If this thread is blocked in an invocation of the wait(), wait(long), or wait(long, int) methods of the Object class, or of the join(), join(long), join(long, int), sleep(long), or sleep(long, int), methods of this class, then its interrupt status will be cleared and it will receive an InterruptedException.</span><br><span class="line"></span><br><span class="line">If this thread is blocked in an I/O operation upon an interruptible channel then the channel will be closed, the thread's interrupt status will be set, and the thread will receive a ClosedByInterruptException.</span><br><span class="line"></span><br><span class="line">If this thread is blocked in a Selector then the thread's interrupt status will be set and it will return immediately from the selection operation, possibly with a non-zero value, just as if the selector's wakeup method were invoked.</span><br><span class="line"></span><br><span class="line">If none of the previous conditions hold then this thread's interrupt status will be set.</span><br><span class="line"></span><br><span class="line">Interrupting a thread that is not alive need not have any effect.</span><br></pre></td></tr></table></figure>
<p>大致意思是：</p>
<p>interrupt()的作用是中断本线程。<br>本线程中断自己是被允许的；其它线程调用本线程的interrupt()方法时，会通过checkAccess()检查权限。这有可能抛出SecurityException异常。<br>如果本线程是处于阻塞状态：调用线程的wait(), wait(long)或wait(long, int)会让它进入等待(阻塞)状态，或者调用线程的join(), join(long), join(long, int), sleep(long), sleep(long, int)也会让它进入阻塞状态。若线程在阻塞状态时，调用了它的interrupt()方法，那么它的“中断状态”会被清除并且会收到一个InterruptedException异常。例如，线程通过wait()进入阻塞状态，此时通过interrupt()中断该线程；调用interrupt()会立即将线程的中断标记设为“true”，但是由于线程处于阻塞状态，所以该“中断标记”会立即被清除为“false”，同时，会产生一个InterruptedException的异常。<br>如果线程被阻塞在一个Selector选择器中，那么通过interrupt()中断它时；线程的中断标记会被设置为true，并且它会立即从选择操作中返回。<br>如果不属于前面所说的情况，那么通过interrupt()中断线程时，它的中断标记会被设置为“true”。<br>中断一个“已终止的线程”不会产生任何操作。</p>
<h3 id="2-终止线程的方式"><a href="#2-终止线程的方式" class="headerlink" title="2. 终止线程的方式"></a><strong><a></a>2. 终止线程的方式</strong></h3><p><strong>Thread 中的 stop() 和 suspend() 方法，由于固有的不安全性，已经建议不再使用！</strong><br>下面，我先分别讨论线程在 “阻塞状态” 和“运行状态”的终止方式，然后再总结出一个通用的方式。</p>
<h3 id="2-1-终止处于-“阻塞状态”-的线程"><a href="#2-1-终止处于-“阻塞状态”-的线程" class="headerlink" title="2.1 终止处于 “阻塞状态” 的线程"></a><a></a>2.1 终止处于 “阻塞状态” 的线程</h3><p>通常，我们通过 “中断” 方式终止处于 “阻塞状态” 的线程。<br>当线程由于被调用了 sleep(), wait(), join() 等方法而进入阻塞状态；若此时调用线程的 interrupt() 将线程的中断标记设为 true。由于处于阻塞状态，中断标记会被清除，同时产生一个 InterruptedException 异常。将 InterruptedException 放在适当的位置就能终止线程，形式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">// 执行任务...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">        <span class="comment">// 由于产生InterruptedException异常，退出while(true)循环，线程终止！</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明</strong>：在 while(true) 中不断的执行任务，当线程处于阻塞状态时，调用线程的 interrupt() 产生 InterruptedException 中断。中断的捕获在 while(true) 之外，这样就退出了 while(true) 循环！<br>注意：<strong>对 InterruptedException 的捕获务一般放在 while(true) 循环体的外面</strong>，这样，在产生异常时就退出了 while(true) 循环。否则，InterruptedException 在 while(true) 循环体之内，就需要额外的添加退出处理。形式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 执行任务...</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">            <span class="comment">// InterruptedException在while(true)循环体内。</span></span><br><span class="line">            <span class="comment">// 当线程产生了InterruptedException异常时，while(true)仍能继续运行！需要手动退出</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明：上面的 InterruptedException 异常的捕获在 whle(true) 之内。当产生 InterruptedException 异常时，被 catch 处理之外，仍然在 while(true) 循环体内；要退出 while(true) 循环体，需要额外的执行退出 while(true) 的操作。</p>
<h3 id="2-2-终止处于-“运行状态”-的线程"><a href="#2-2-终止处于-“运行状态”-的线程" class="headerlink" title="2.2 终止处于 “运行状态” 的线程"></a><a></a>2.2 终止处于 “运行状态” 的线程</h3><p>通常，我们通过 “标记” 方式终止处于 “运行状态” 的线程。其中，包括“<strong>中断标记</strong>” 和 “<strong>额外添加标记</strong>”。<br><strong>(01) 通过 “中断标记” 终止线程。</strong><br>形式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!isInterrupted()) &#123;</span><br><span class="line">        <span class="comment">// 执行任务...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明</strong>：isInterrupted() 是判断线程的中断标记是不是为 true。当线程处于运行状态，并且我们需要终止它时；可以调用线程的 interrupt() 方法，使用线程的中断标记为 true，即 isInterrupted() 会返回 true。此时，就会退出 while 循环。<br>注意：<strong>interrupt()并不会终止处于 “运行状态” 的线程！它会将线程的中断标记设为 true。</strong></p>
<p><strong>(02) 通过 “额外添加标记”。</strong><br>形式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> flag= <span class="keyword">true</span>;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">stopTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    flag = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (flag) &#123;</span><br><span class="line">        <span class="comment">// 执行任务...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明</strong>：线程中有一个 flag 标记，它的默认值是 true；并且我们提供 stopTask() 来设置 flag 标记。当我们需要终止该线程时，调用该线程的 stopTask() 方法就可以让线程退出 while 循环。<br>注意：将 flag 定义为 volatile 类型，是为了保证 flag 的<strong>可见性</strong>。即其它线程通过 stopTask() 修改了 flag 之后，本线程能看到修改后的 flag 的值。</p>
<p>综合线程处于 “阻塞状态” 和“运行状态”的终止方式，比较通用的终止线程的形式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1\. isInterrupted()保证，只要中断标记为true就终止线程。</span></span><br><span class="line">        <span class="keyword">while</span> (!isInterrupted()) &#123;</span><br><span class="line">            <span class="comment">// 执行任务...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">        <span class="comment">// 2\. InterruptedException异常保证，当InterruptedException异常产生时，线程被终止。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-终止线程的示例"><a href="#3-终止线程的示例" class="headerlink" title="3. 终止线程的示例"></a><strong><a></a>3. 终止线程的示例</strong></h2><p>interrupt()常常被用来终止 “阻塞状态” 线程。参考下面示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Demo1.java的源码</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (!isInterrupted()) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">                i++;</span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" ("</span>+<span class="keyword">this</span>.getState()+<span class="string">") loop "</span> + i);  </span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </span><br><span class="line">            System.out.println(Thread.currentThread().getName() +<span class="string">" ("</span>+<span class="keyword">this</span>.getState()+<span class="string">") catch InterruptedException."</span>);  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            Thread t1 = <span class="keyword">new</span> MyThread(<span class="string">"t1"</span>);  <span class="comment">// 新建“线程t1”</span></span><br><span class="line">            System.out.println(t1.getName() +<span class="string">" ("</span>+t1.getState()+<span class="string">") is new."</span>);  </span><br><span class="line"></span><br><span class="line">            t1.start();                      <span class="comment">// 启动“线程t1”</span></span><br><span class="line">            System.out.println(t1.getName() +<span class="string">" ("</span>+t1.getState()+<span class="string">") is started."</span>);  </span><br><span class="line"></span><br><span class="line">            <span class="comment">// 主线程休眠300ms，然后主线程给t1发“中断”指令。</span></span><br><span class="line">            Thread.sleep(<span class="number">300</span>);</span><br><span class="line">            t1.interrupt();</span><br><span class="line">            System.out.println(t1.getName() +<span class="string">" ("</span>+t1.getState()+<span class="string">") is interrupted."</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 主线程休眠300ms，然后查看t1的状态。</span></span><br><span class="line">            Thread.sleep(<span class="number">300</span>);</span><br><span class="line">            System.out.println(t1.getName() +<span class="string">" ("</span>+t1.getState()+<span class="string">") is interrupted now."</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">t1 (NEW) is new.</span><br><span class="line">t1 (RUNNABLE) is started.</span><br><span class="line">t1 (RUNNABLE) loop 1</span><br><span class="line">t1 (RUNNABLE) loop 2</span><br><span class="line">t1 (TIMED_WAITING) is interrupted.</span><br><span class="line">t1 (RUNNABLE) catch InterruptedException.</span><br><span class="line">t1 (TERMINATED) is interrupted now.</span><br></pre></td></tr></table></figure>
<p><strong>结果说明</strong>：<br>(01) 主线程 main 中通过 new MyThread(“t1”) 创建线程 t1，之后通过 t1.start() 启动线程 t1。<br>(02) t1 启动之后，会不断的检查它的中断标记，如果中断标记为 “false”；则休眠 100ms。<br>(03) t1 休眠之后，会切换到主线程 main；主线程再次运行时，会执行 t1.interrupt()中断线程 t1。t1 收到中断指令之后，会将 t1 的中断标记设置 “false”，而且会抛出 InterruptedException 异常。在 t1 的 run() 方法中，是在循环体 while 之外捕获的异常；因此循环被终止。</p>
<p>我们对上面的结果进行小小的修改，将 run() 方法中捕获 InterruptedException 异常的代码块移到 while 循环体内。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Demo2.java的源码</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (!isInterrupted()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">                System.out.println(Thread.currentThread().getName() +<span class="string">" ("</span>+<span class="keyword">this</span>.getState()+<span class="string">") catch InterruptedException."</span>);  </span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">" ("</span>+<span class="keyword">this</span>.getState()+<span class="string">") loop "</span> + i);  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            Thread t1 = <span class="keyword">new</span> MyThread(<span class="string">"t1"</span>);  <span class="comment">// 新建“线程t1”</span></span><br><span class="line">            System.out.println(t1.getName() +<span class="string">" ("</span>+t1.getState()+<span class="string">") is new."</span>);  </span><br><span class="line"></span><br><span class="line">            t1.start();                      <span class="comment">// 启动“线程t1”</span></span><br><span class="line">            System.out.println(t1.getName() +<span class="string">" ("</span>+t1.getState()+<span class="string">") is started."</span>);  </span><br><span class="line"></span><br><span class="line">            <span class="comment">// 主线程休眠300ms，然后主线程给t1发“中断”指令。</span></span><br><span class="line">            Thread.sleep(<span class="number">300</span>);</span><br><span class="line">            t1.interrupt();</span><br><span class="line">            System.out.println(t1.getName() +<span class="string">" ("</span>+t1.getState()+<span class="string">") is interrupted."</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 主线程休眠300ms，然后查看t1的状态。</span></span><br><span class="line">            Thread.sleep(<span class="number">300</span>);</span><br><span class="line">            System.out.println(t1.getName() +<span class="string">" ("</span>+t1.getState()+<span class="string">") is interrupted now."</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;c</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">t1 (NEW) is new.</span><br><span class="line">t1 (RUNNABLE) is started.</span><br><span class="line">t1 (RUNNABLE) loop 1</span><br><span class="line">t1 (RUNNABLE) loop 2</span><br><span class="line">t1 (TIMED_WAITING) is interrupted.</span><br><span class="line">t1 (RUNNABLE) catch InterruptedException.</span><br><span class="line">t1 (RUNNABLE) loop 3</span><br><span class="line">t1 (RUNNABLE) loop 4</span><br><span class="line">t1 (RUNNABLE) loop 5</span><br><span class="line">t1 (TIMED_WAITING) is interrupted now.</span><br><span class="line">t1 (RUNNABLE) loop 6</span><br><span class="line">t1 (RUNNABLE) loop 7</span><br><span class="line">t1 (RUNNABLE) loop 8</span><br><span class="line">t1 (RUNNABLE) loop 9</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><strong>结果说明</strong>：<br>程序进入了死循环！<br>为什么会这样呢？这是因为，t1 在 “等待(阻塞) 状态”时，被 interrupt()中断；<strong>此时，会清除中断标记</strong> [即 isInterrupted() 会返回 false]，而且会抛出 InterruptedException 异常[该异常在 while 循环体内被捕获]。因此，t1 理所当然的会进入死循环了。<br>解决该问题，需要我们在捕获异常时，额外的进行退出 while 循环的处理。例如，在 MyThread 的 catch(InterruptedException) 中添加 break 或 return 就能解决该问题。</p>
<p>下面是通过 “额外添加标记” 的方式终止 “状态状态” 的线程的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Demo3.java的源码</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> flag= <span class="keyword">true</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        flag = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span> (flag) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>); <span class="comment">// 休眠100ms</span></span><br><span class="line">                    i++;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName()+<span class="string">" ("</span>+<span class="keyword">this</span>.getState()+<span class="string">") loop "</span> + i);  </span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;  </span><br><span class="line">                System.out.println(Thread.currentThread().getName() +<span class="string">" ("</span>+<span class="keyword">this</span>.getState()+<span class="string">") catch InterruptedException."</span>);  </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            MyThread t1 = <span class="keyword">new</span> MyThread(<span class="string">"t1"</span>);  <span class="comment">// 新建“线程t1”</span></span><br><span class="line">            System.out.println(t1.getName() +<span class="string">" ("</span>+t1.getState()+<span class="string">") is new."</span>);  </span><br><span class="line"></span><br><span class="line">            t1.start();                      <span class="comment">// 启动“线程t1”</span></span><br><span class="line">            System.out.println(t1.getName() +<span class="string">" ("</span>+t1.getState()+<span class="string">") is started."</span>);  </span><br><span class="line"></span><br><span class="line">            <span class="comment">// 主线程休眠300ms，然后主线程给t1发“中断”指令。</span></span><br><span class="line">            Thread.sleep(<span class="number">300</span>);</span><br><span class="line">            t1.stopTask();</span><br><span class="line">            System.out.println(t1.getName() +<span class="string">" ("</span>+t1.getState()+<span class="string">") is interrupted."</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 主线程休眠300ms，然后查看t1的状态。</span></span><br><span class="line">            Thread.sleep(<span class="number">300</span>);</span><br><span class="line">            System.out.println(t1.getName() +<span class="string">" ("</span>+t1.getState()+<span class="string">") is interrupted now."</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">t1 (NEW) is new.</span><br><span class="line">t1 (RUNNABLE) is started.</span><br><span class="line">t1 (RUNNABLE) loop 1</span><br><span class="line">t1 (RUNNABLE) loop 2</span><br><span class="line">t1 (TIMED_WAITING) is interrupted.</span><br><span class="line">t1 (RUNNABLE) loop 3</span><br><span class="line">t1 (TERMINATED) is interrupted now.</span><br></pre></td></tr></table></figure>
<h2 id="4-interrupted-和-isInterrupted-的区别"><a href="#4-interrupted-和-isInterrupted-的区别" class="headerlink" title="4. interrupted() 和 isInterrupted() 的区别"></a><strong><a></a>4. interrupted() 和 isInterrupted() 的区别</strong></h2><p>最后谈谈 interrupted() 和 isInterrupted()。<br>interrupted() 和 isInterrupted() 都能够用于检测对象的 “中断标记”。<br>区别是，<strong>interrupted()除了返回中断标记之外，它还会清除中断标记 (即将中断标记设为 false)；而 isInterrupted() 仅仅返回中断标记。</strong></p>
<hr>
<h1 id="10-线程优先级和守护线程"><a href="#10-线程优先级和守护线程" class="headerlink" title="10 线程优先级和守护线程"></a>10 线程优先级和守护线程</h1><h2 id="概要-8"><a href="#概要-8" class="headerlink" title="概要"></a><strong>概要</strong></h2><p>本章，会对守护线程和线程优先级进行介绍。涉及到的内容包括：<br><a href="#p1">1. 线程优先级的介绍</a><br><a href="#p2">2. 线程优先级的示例</a><br><a href="#p3">3. 守护线程的示例</a></p>
<h2 id="1-线程优先级的介绍"><a href="#1-线程优先级的介绍" class="headerlink" title="1. 线程优先级的介绍"></a><strong><a></a>1. 线程优先级的介绍</strong></h2><p>java 中的线程优先级的范围是 1～10，默认的优先级是 5。“高优先级线程”会优先于 “低优先级线程” 执行。</p>
<blockquote>
<p>daemon：美 [‘dimən]</p>
</blockquote>
<p>java 中有两种线程：<strong>用户线程</strong>和<strong>守护线程</strong>。可以通过 isDaemon() 方法来区别它们：如果返回 false，则说明该线程是 “用户线程”；否则就是 “守护线程”。<br>用户线程一般是用户执行的用户级任务，而守护线程也就是 “后台线程”，一般用来执行后台任务。需要注意的是：<strong>Java 虚拟机在“用户线程” 都结束后会后退出。</strong></p>
<p>JDK 中关于线程优先级和守护线程的介绍如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Every thread has a priority. Threads with higher priority are executed in preference to threads with lower priority. Each thread may or may not also be marked as a daemon. When code running in some thread creates a new Thread object, the new thread has its priority initially set equal to the priority of the creating thread, and is a daemon thread if and only if the creating thread is a daemon.</span><br><span class="line"></span><br><span class="line">When a Java Virtual Machine starts up, there is usually a single non-daemon thread (which typically calls the method named main of some designated class). The Java Virtual Machine continues to execute threads until either of the following occurs:</span><br><span class="line"></span><br><span class="line">The exit method of class Runtime has been called and the security manager has permitted the exit operation to take place.</span><br><span class="line">All threads that are not daemon threads have died, either by returning from the call to the run method or by throwing an exception that propagates beyond the run method. </span><br><span class="line">Marks this thread as either a daemon thread or a user thread. The Java Virtual Machine exits when the only threads running are all daemon threads.</span><br></pre></td></tr></table></figure>
<p>大致意思是：</p>
<p>每个线程都有一个优先级。“高优先级线程”会优先于“低优先级线程”执行。每个线程都可以被标记为一个守护进程或非守护进程。在一些运行的主线程中创建新的子线程时，子线程的优先级被设置为<strong>等于</strong>“创建它的主线程的优先级”，<strong>当且仅当“创建它的主线程是守护线程”时“子线程才会是守护线程”。</strong></p>
<p>当Java虚拟机启动时，通常有一个单一的非守护线程（该线程通过是通过main()方法启动）。JVM会一直运行直到下面的任意一个条件发生，JVM就会终止运行：<br>(01) 调用了exit()方法，并且exit()有权限被正常执行。<br>(02) 所有的“非守护线程”都死了(即JVM中仅仅只有“守护线程”)。</p>
<p>每一个线程都被标记为“守护线程”或“用户线程”。当只有守护线程运行时，JVM会自动退出。</p>
<h2 id="2-线程优先级的示例"><a href="#2-线程优先级的示例" class="headerlink" title="2. 线程优先级的示例"></a><strong><a></a>2. 线程优先级的示例</strong></h2><p>我们先看看优先级的示例 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++) &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()</span><br><span class="line">                    +<span class="string">"("</span>+Thread.currentThread().getPriority()+ <span class="string">")"</span></span><br><span class="line">                    +<span class="string">", loop "</span>+i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName()</span><br><span class="line">                +<span class="string">"("</span>+Thread.currentThread().getPriority()+ <span class="string">")"</span>);</span><br><span class="line"></span><br><span class="line">        Thread t1=<span class="keyword">new</span> MyThread(<span class="string">"t1"</span>);    <span class="comment">// 新建t1</span></span><br><span class="line">        Thread t2=<span class="keyword">new</span> MyThread(<span class="string">"t2"</span>);    <span class="comment">// 新建t2</span></span><br><span class="line">        t1.setPriority(<span class="number">1</span>);                <span class="comment">// 设置t1的优先级为1</span></span><br><span class="line">        t2.setPriority(<span class="number">10</span>);                <span class="comment">// 设置t2的优先级为10</span></span><br><span class="line">        t1.start();                        <span class="comment">// 启动t1</span></span><br><span class="line">        t2.start();                        <span class="comment">// 启动t2</span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">main(5)</span><br><span class="line">t1(1), loop 0</span><br><span class="line">t2(10), loop 0</span><br><span class="line">t1(1), loop 1</span><br><span class="line">t2(10), loop 1</span><br><span class="line">t1(1), loop 2</span><br><span class="line">t2(10), loop 2</span><br><span class="line">t1(1), loop 3</span><br><span class="line">t2(10), loop 3</span><br><span class="line">t1(1), loop 4</span><br><span class="line">t2(10), loop 4</span><br></pre></td></tr></table></figure>
<p><strong>结果说明</strong>：<br>(01) 主线程 main 的优先级是 5。<br>(02) t1 的优先级被设为 1，而 t2 的优先级被设为 10。cpu 在执行 t1 和 t2 的时候，<strong>根据时间片轮循调度</strong>，所以能够并发执行。</p>
<h2 id="3-守护线程的示例"><a href="#3-守护线程的示例" class="headerlink" title="3. 守护线程的示例"></a><strong><a></a>3. 守护线程的示例</strong></h2><p>下面是守护线程的示例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Demo.java</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">3</span>);</span><br><span class="line">                System.out.println(<span class="keyword">this</span>.getName() +<span class="string">"(isDaemon="</span>+<span class="keyword">this</span>.isDaemon()+ <span class="string">")"</span> +<span class="string">", loop "</span>+i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyDaemon</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyDaemon</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10000</span>; i++) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1</span>);</span><br><span class="line">                System.out.println(<span class="keyword">this</span>.getName() +<span class="string">"(isDaemon="</span>+<span class="keyword">this</span>.isDaemon()+ <span class="string">")"</span> +<span class="string">", loop "</span>+i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName()</span><br><span class="line">                +<span class="string">"(isDaemon="</span>+Thread.currentThread().isDaemon()+ <span class="string">")"</span>);</span><br><span class="line"></span><br><span class="line">        Thread t1=<span class="keyword">new</span> MyThread(<span class="string">"t1"</span>);    <span class="comment">// 新建t1</span></span><br><span class="line">        Thread t2=<span class="keyword">new</span> MyDaemon(<span class="string">"t2"</span>);    <span class="comment">// 新建t2</span></span><br><span class="line">        t2.setDaemon(<span class="keyword">true</span>);                <span class="comment">// 设置t2为守护线程</span></span><br><span class="line">        t1.start();                        <span class="comment">// 启动t1</span></span><br><span class="line">        t2.start();                        <span class="comment">// 启动t2</span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">main(isDaemon=false)</span><br><span class="line">t2(isDaemon=true), loop 0</span><br><span class="line">t2(isDaemon=true), loop 1</span><br><span class="line">t1(isDaemon=false), loop 0</span><br><span class="line">t2(isDaemon=true), loop 2</span><br><span class="line">t2(isDaemon=true), loop 3</span><br><span class="line">t1(isDaemon=false), loop 1</span><br><span class="line">t2(isDaemon=true), loop 4</span><br><span class="line">t2(isDaemon=true), loop 5</span><br><span class="line">t2(isDaemon=true), loop 6</span><br><span class="line">t1(isDaemon=false), loop 2</span><br><span class="line">t2(isDaemon=true), loop 7</span><br><span class="line">t2(isDaemon=true), loop 8</span><br><span class="line">t2(isDaemon=true), loop 9</span><br><span class="line">t1(isDaemon=false), loop 3</span><br><span class="line">t2(isDaemon=true), loop 10</span><br><span class="line">t2(isDaemon=true), loop 11</span><br><span class="line">t1(isDaemon=false), loop 4</span><br><span class="line">t2(isDaemon=true), loop 12</span><br></pre></td></tr></table></figure>
<p><strong>结果说明</strong>：<br>(01) 主线程 main 是用户线程，它创建的子线程 t1 也是用户线程。<br>(02) t2 是守护线程。在 “主线程 main” 和“子线程 t1”(它们都是用户线程)执行完毕，<strong>只剩 t2 这个守护线程的时候，JVM 自动退出。</strong></p>
<hr>
<h1 id="11-生产消费者问题"><a href="#11-生产消费者问题" class="headerlink" title="11 生产消费者问题"></a>11 生产消费者问题</h1><h2 id="概要-9"><a href="#概要-9" class="headerlink" title="概要"></a><strong>概要</strong></h2><p>本章，会对 “生产 / 消费者问题” 进行讨论。涉及到的内容包括：<br><a href="#p1">1. 生产 / 消费者模型</a><br><a href="#p2">2. 生产 / 消费者实现</a></p>
<h2 id="1-生产-消费者模型"><a href="#1-生产-消费者模型" class="headerlink" title="1. 生产 / 消费者模型"></a><strong><a></a>1. 生产 / 消费者模型</strong></h2><p>生产 / 消费者问题是个非常典型的多线程问题，涉及到的对象包括 “生产者”、“消费者”、“仓库” 和“产品”。他们之间的关系如下：<br>(01) 生产者仅仅在仓储未满时候生产，仓满则停止生产。<br>(02) 消费者仅仅在仓储有产品时候才能消费，仓空则等待。<br>(03) 当消费者发现仓储没产品可消费时候会通知生产者生产。<br>(04) 生产者在生产出可消费产品时候，应该通知等待的消费者去消费。</p>
<h2 id="2-生产-消费者实现"><a href="#2-生产-消费者实现" class="headerlink" title="2. 生产 / 消费者实现"></a><strong><a></a>2. 生产 / 消费者实现</strong></h2><p>下面通过 wait()/notify() 方式实现该模型 (<em>后面在学习了线程池相关内容之后，再通过其它方式实现生产 / 消费者模型</em>)。源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Demo1.java</span></span><br><span class="line"><span class="comment">// 仓库</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Depot</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> capacity;    <span class="comment">// 仓库的容量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size;        <span class="comment">// 仓库的实际数量</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Depot</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.capacity = capacity;</span><br><span class="line">        <span class="keyword">this</span>.size = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="comment">// left 表示“想要生产的数量”(有可能生产量太多，需多此生产)</span></span><br><span class="line">            <span class="keyword">int</span> left = val;</span><br><span class="line">            <span class="keyword">while</span> (left &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 库存已满时，等待“消费者”消费产品。</span></span><br><span class="line">                <span class="keyword">while</span> (size &gt;= capacity)</span><br><span class="line">                    wait();</span><br><span class="line">                <span class="comment">// 获取“实际生产的数量”(即库存中新增的数量)</span></span><br><span class="line">                <span class="comment">// 如果“库存”+“想要生产的数量”&gt;“总的容量”，则“实际增量”=“总的容量”-“当前容量”。(此时填满仓库)</span></span><br><span class="line">                <span class="comment">// 否则“实际增量”=“想要生产的数量”</span></span><br><span class="line">                <span class="keyword">int</span> inc = (size+left)&gt;capacity ? (capacity-size) : left;</span><br><span class="line">                size += inc;</span><br><span class="line">                left -= inc;</span><br><span class="line">                System.out.printf(<span class="string">"%s produce(%3d) --&gt; left=%3d, inc=%3d, size=%3d\n"</span>, </span><br><span class="line">                        Thread.currentThread().getName(), val, left, inc, size);</span><br><span class="line">                <span class="comment">// 通知“消费者”可以消费了。</span></span><br><span class="line">                notifyAll();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// left 表示“客户要消费数量”(有可能消费量太大，库存不够，需多此消费)</span></span><br><span class="line">            <span class="keyword">int</span> left = val;</span><br><span class="line">            <span class="keyword">while</span> (left &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 库存为0时，等待“生产者”生产产品。</span></span><br><span class="line">                <span class="keyword">while</span> (size &lt;= <span class="number">0</span>)</span><br><span class="line">                    wait();</span><br><span class="line">                <span class="comment">// 获取“实际消费的数量”(即库存中实际减少的数量)</span></span><br><span class="line">                <span class="comment">// 如果“库存”&lt;“客户要消费的数量”，则“实际消费量”=“库存”；</span></span><br><span class="line">                <span class="comment">// 否则，“实际消费量”=“客户要消费的数量”。</span></span><br><span class="line">                <span class="keyword">int</span> dec = (size&lt;left) ? size : left;</span><br><span class="line">                size -= dec;</span><br><span class="line">                left -= dec;</span><br><span class="line">                System.out.printf(<span class="string">"%s consume(%3d) &lt;-- left=%3d, dec=%3d, size=%3d\n"</span>, </span><br><span class="line">                        Thread.currentThread().getName(), val, left, dec, size);</span><br><span class="line">                notifyAll();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"capacity:"</span>+capacity+<span class="string">", actual size:"</span>+size;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 生产者</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Depot depot;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(Depot depot)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.depot = depot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消费产品：新建一个线程向仓库中生产产品。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                depot.produce(val);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Customer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Depot depot;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Customer</span><span class="params">(Depot depot)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.depot = depot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消费产品：新建一个线程从仓库中消费产品。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                depot.consume(val);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1</span> </span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line">        Depot mDepot = <span class="keyword">new</span> Depot(<span class="number">100</span>);</span><br><span class="line">        Producer mPro = <span class="keyword">new</span> Producer(mDepot);</span><br><span class="line">        Customer mCus = <span class="keyword">new</span> Customer(mDepot);</span><br><span class="line"></span><br><span class="line">        mPro.produce(<span class="number">60</span>);</span><br><span class="line">        mPro.produce(<span class="number">120</span>);</span><br><span class="line">        mCus.consume(<span class="number">90</span>);</span><br><span class="line">        mCus.consume(<span class="number">150</span>);</span><br><span class="line">        mPro.produce(<span class="number">110</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明</strong>：<br>(01) Producer 是 “生产者” 类，它与 “仓库(depot)” 关联。当调用 “生产者” 的 produce()方法时，它会新建一个线程并向 “仓库” 中生产产品。<br>(02) Customer 是 “消费者” 类，它与 “仓库(depot)” 关联。当调用 “消费者” 的 consume()方法时，它会新建一个线程并消费 “仓库” 中的产品。<br>(03) Depot 是 “仓库” 类，仓库中记录 “仓库的容量(capacity)” 以及“仓库中当前产品数目(size)”。<br>        “仓库”类的生产方法 produce()和消费方法 consume()方法都是 synchronized 方法，进入 synchronized 方法体，意味着这个线程获取到了该 “仓库” 对象的同步锁。这也就是说，同一时间，生产者和消费者线程只能有一个能运行。通过同步锁，实现了对 “仓库” 的互斥访问。<br>       <strong>对于生产方法 produce() 而言</strong>：当仓库满时，生产者线程等待，需要等待消费者消费产品之后，生产线程才能生产；生产者线程生产完产品之后，会通过 notifyAll() 唤醒同步锁上的所有线程，包括 “消费者线程”，即我们所说的 “通知消费者进行消费”。<br>      <strong>对于消费方法 consume() 而言</strong>：当仓库为空时，消费者线程等待，需要等待生产者生产产品之后，消费者线程才能消费；消费者线程消费完产品之后，会通过 notifyAll() 唤醒同步锁上的所有线程，包括 “生产者线程”，即我们所说的 “通知生产者进行生产”。</p>
<p><strong>(某一次) 运行结果</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Thread-0 produce( 60) --&gt; left=  0, inc= 60, size= 60</span><br><span class="line">Thread-4 produce(110) --&gt; left= 70, inc= 40, size=100</span><br><span class="line">Thread-2 consume( 90) &lt;-- left=  0, dec= 90, size= 10</span><br><span class="line">Thread-3 consume(150) &lt;-- left=140, dec= 10, size=  0</span><br><span class="line">Thread-1 produce(120) --&gt; left= 20, inc=100, size=100</span><br><span class="line">Thread-3 consume(150) &lt;-- left= 40, dec=100, size=  0</span><br><span class="line">Thread-4 produce(110) --&gt; left=  0, inc= 70, size= 70</span><br><span class="line">Thread-3 consume(150) &lt;-- left=  0, dec= 40, size= 30</span><br><span class="line">Thread-1 produce(120) --&gt; left=  0, inc= 20, size= 50</span><br></pre></td></tr></table></figure>
<hr>
<blockquote>
<p>原文地址：<br><a href="http://www.cnblogs.com/skywang12345/p/java_threads_category.html" target="_blank" rel="noopener">http://www.cnblogs.com/skywang12345/p/java_threads_category.html</a></p>
</blockquote>

      
    </div>
    
    
    


     
    
      <div>
        
    <div style="text-align:center;color: #ccc;font-size:14px;">
        ------ 本文结束<i class="fa fa-paw"></i>感谢您的阅读 ------</div>

      </div>
    


    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    CloudPai
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://cloudpai.site/2018/03/23/2018-03-23-1/" title="java多线程系列一：基础篇">http://cloudpai.site/2018/03/23/2018-03-23-1/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    




    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/java/" rel="tag"><i class="fa fa-tag"></i> java</a>
          
            <a href="/tags/并发/" rel="tag"><i class="fa fa-tag"></i> 并发</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/03/23/2018-03-23/" rel="next" title="java 并发 多线程 面试总结 top50+top40">
                <i class="fa fa-chevron-left"></i> java 并发 多线程 面试总结 top50+top40
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/03/24/2018-03-24/" rel="prev" title="java多线程系列二：JUC原子类">
                java多线程系列二：JUC原子类 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>




  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="http://p4lmrb1gp.bkt.clouddn.com/君名-squashed.jpg"
                alt="CloudPai" />
            
              <p class="site-author-name" itemprop="name">CloudPai</p>
              <p class="site-description motion-element" itemprop="description">加油(๑•̀ㅂ•́)و✧加油</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">81</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            


<div id="music163player">
    <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=280 height=240 src="//music.163.com/outchain/player?type=0&id=2113726971&auto=0&height=430"></iframe>
</div>
<!-- 459004290 -->




            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">33</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/CloudPai" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:liupai024@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.douban.com/people/57965969/doulists/all" target="_blank" title="豆瓣">
                      
                        <i class="fa fa-fw fa-book"></i>豆瓣</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/cloudPai/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-edit"></i>知乎</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.dlut.edu.cn/" title="DUT" target="_blank">DUT</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.bupt.edu.cn/" title="BUPT" target="_blank">BUPT</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://campus.alibaba.com/index.htm" title="Alibaba Group" target="_blank">Alibaba Group</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#01-基本概念"><span class="nav-text">01 基本概念</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#02-常用的实现多线程的两种方式"><span class="nav-text">02 常用的实现多线程的两种方式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#概要"><span class="nav-text">概要</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Thread-和-Runnable-简介"><span class="nav-text">Thread 和 Runnable 简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Thread-和-Runnable-的异同点"><span class="nav-text">Thread 和 Runnable 的异同点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Thread-和-Runnable-的多线程示例"><span class="nav-text">Thread 和 Runnable 的多线程示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Thread-的多线程示例"><span class="nav-text">1. Thread 的多线程示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Runnable-的多线程示例"><span class="nav-text">2. Runnable 的多线程示例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#03-Thread中start-和run-的区别"><span class="nav-text">03 Thread中start()和run()的区别</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#概要-1"><span class="nav-text">概要</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#start-和-run-的区别说明"><span class="nav-text">start() 和 run() 的区别说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#start-和-run-的区别示例"><span class="nav-text">start() 和 run() 的区别示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#start-和-run-相关源码-基于-JDK1-7-0-40"><span class="nav-text">start() 和 run() 相关源码 (基于 JDK1.7.0_40)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#04-synchronized关键字"><span class="nav-text">04 synchronized关键字</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#概要-2"><span class="nav-text">概要</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-synchronized-原理"><span class="nav-text">1. synchronized 原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-synchronized-基本规则"><span class="nav-text">2. synchronized 基本规则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#第一条"><span class="nav-text">第一条</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第二条"><span class="nav-text">第二条</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第三条"><span class="nav-text">第三条</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-synchronized-方法-和-synchronized-代码块"><span class="nav-text">3. synchronized 方法 和 synchronized 代码块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-实例锁-和-全局锁"><span class="nav-text">4. 实例锁 和 全局锁</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#05-线程等待与唤醒"><span class="nav-text">05 线程等待与唤醒</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#概要-3"><span class="nav-text">概要</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-wait-notify-notifyAll-等方法介绍"><span class="nav-text">1.wait(), notify(), notifyAll() 等方法介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-wait-和-notify-示例"><span class="nav-text">2. wait() 和 notify() 示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-wait-long-timeout-和-notify"><span class="nav-text">3. wait(long timeout) 和 notify()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-wait-和-notifyAll"><span class="nav-text">4. wait() 和 notifyAll()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-为什么-notify-wait-等函数定义在-Object-中，而不是-Thread-中"><span class="nav-text">5. 为什么 notify(), wait() 等函数定义在 Object 中，而不是 Thread 中</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#06-线程让步"><span class="nav-text">06 线程让步</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#概要-4"><span class="nav-text">概要</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-yield-介绍"><span class="nav-text">1. yield() 介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-yield-示例"><span class="nav-text">2. yield() 示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-yield-与-wait-的比较"><span class="nav-text">3. yield() 与 wait() 的比较</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#07-线程休眠"><span class="nav-text">07 线程休眠</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#概要-5"><span class="nav-text">概要</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-sleep-介绍"><span class="nav-text">1. sleep() 介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-sleep-示例"><span class="nav-text">2. sleep() 示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-sleep-与-wait-的比较"><span class="nav-text">3. sleep() 与 wait() 的比较</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#08-join"><span class="nav-text">08 join()</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#概要-6"><span class="nav-text">概要</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-join-介绍"><span class="nav-text">1. join() 介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-join-源码分析-基于-JDK1-7-0-40"><span class="nav-text">2. join() 源码分析 (基于 JDK1.7.0_40)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-join-示例"><span class="nav-text">3. join() 示例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#09-interrupt-和线程终止方式"><span class="nav-text">09 interrupt()和线程终止方式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#概要-7"><span class="nav-text">概要</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-interrupt-说明"><span class="nav-text">1. interrupt() 说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-终止线程的方式"><span class="nav-text">2. 终止线程的方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-终止处于-“阻塞状态”-的线程"><span class="nav-text">2.1 终止处于 “阻塞状态” 的线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-终止处于-“运行状态”-的线程"><span class="nav-text">2.2 终止处于 “运行状态” 的线程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-终止线程的示例"><span class="nav-text">3. 终止线程的示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-interrupted-和-isInterrupted-的区别"><span class="nav-text">4. interrupted() 和 isInterrupted() 的区别</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#10-线程优先级和守护线程"><span class="nav-text">10 线程优先级和守护线程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#概要-8"><span class="nav-text">概要</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-线程优先级的介绍"><span class="nav-text">1. 线程优先级的介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-线程优先级的示例"><span class="nav-text">2. 线程优先级的示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-守护线程的示例"><span class="nav-text">3. 守护线程的示例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#11-生产消费者问题"><span class="nav-text">11 生产消费者问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#概要-9"><span class="nav-text">概要</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-生产-消费者模型"><span class="nav-text">1. 生产 / 消费者模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-生产-消费者实现"><span class="nav-text">2. 生产 / 消费者实现</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CloudPai</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">377.1k</span>
  
</div>




<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv">  </span>
</span>
</div>







  <div class="theme-info">&#12288;主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://cloudpai.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://cloudpai.site/2018/03/23/2018-03-23-1/';
          this.page.identifier = '2018/03/23/2018-03-23-1/';
          this.page.title = 'java多线程系列一：基础篇';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://cloudpai.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  <!-- <!-- <script src="https://cdn.bootcss.com/aplayer/1.6.0/APlayer.min.js"></script>

<script src="https://api.i-meto.com/music/player.js"></script> --> -->
  
  <!--移动端判断，是否引入背景-->
  <script>
  var browser={  
      versions:function(){   
             var u = navigator.userAgent, app = navigator.appVersion;   
             return {//移动终端浏览器版本信息
                  trident: u.indexOf('Trident') > -1, //IE内核
                  presto: u.indexOf('Presto') > -1, //opera内核
                  webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
                  gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
                  mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
                  ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
                  android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
                  iPhone: u.indexOf('iPhone') > -1 , //是否为iPhone或者QQHD浏览器
                  iPad: u.indexOf('iPad') > -1, //是否iPad
                  webApp: u.indexOf('Safari') == -1 //是否web应该程序，没有头部与底部
              };  
           }(),  
           language:(navigator.browserLanguage || navigator.language).toLowerCase()  
  }   
    if(browser.versions.mobile || browser.versions.ios || browser.versions.android ||   
      browser.versions.iPhone || browser.versions.iPad){        
               
    }else{
    document.write("<script type=\'text/javascript\'  src=\'/js/src/particle.js\'><\/script>");
    }
  </script>

  
<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"right","hOffset":-80,"vOffset":-50},"mobile":{"show":false,"scale":0.2},"react":{"opacityDefault":1,"opacityOnHover":0.2}});</script></body>
</html>
